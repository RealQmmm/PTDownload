# æ•°æ®åº“è¿ç§»å Cookie/API Key è§£å¯†é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

å½“æ‚¨ä»ä¸€ä¸ªç¯å¢ƒè¿ç§»æ•°æ®åº“åˆ°å¦ä¸€ä¸ªç¯å¢ƒæ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ç«™ç‚¹é¡µé¢ä¸Šçš„ Cookie å’Œ API Key æ˜¾ç¤ºä¸ºå¯†æ–‡çš„é—®é¢˜ã€‚

## åŸå› åˆ†æ

PTDownload ä½¿ç”¨åŠ å¯†å¯†é’¥æ¥ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼ˆCookie å’Œ API Keyï¼‰ã€‚åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨ `.secret` æ–‡ä»¶ä¸­ï¼š

- **æ—§ç‰ˆæœ¬**ï¼šå¯†é’¥å›ºå®šå­˜å‚¨åœ¨ `/data/.secret`
- **é—®é¢˜**ï¼šè¿ç§»æ•°æ®åº“æ—¶ï¼Œå¦‚æœå¯†é’¥æ–‡ä»¶ä¸ä¸€è‡´ï¼Œæ–°ç¯å¢ƒæ— æ³•è§£å¯†æ—§æ•°æ®

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆå·²ä¿®å¤ï¼‰

### æ–°ç‰ˆæœ¬çš„æ”¹è¿›

ç°åœ¨ç³»ç»Ÿä¼šè‡ªåŠ¨å°†åŠ å¯†å¯†é’¥ä¸æ•°æ®åº“å­˜å‚¨åœ¨åŒä¸€ä½ç½®ï¼š

- **ä½¿ç”¨å†…ç½®æ•°æ®åº“** â†’ å¯†é’¥å­˜å‚¨åœ¨ `/data/.secret`
- **ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“** â†’ å¯†é’¥å­˜å‚¨åœ¨ `/external_db/.secret`

è¿™æ ·å¯ä»¥ç¡®ä¿æ•°æ®åº“å’Œå¯†é’¥å§‹ç»ˆé…å¥—ï¼

### å·¥ä½œåŸç†

```javascript
// å¯†é’¥æ–‡ä»¶è·¯å¾„é€»è¾‘ï¼šè·Ÿéšæ•°æ®åº“ä½ç½®
function getSecretFilePath() {
    const externalDBDir = '/external_db';
    if (fs.existsSync(externalDBDir)) {
        // ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“ï¼Œå¯†é’¥ä¹Ÿå­˜å‚¨åœ¨å¤–éƒ¨
        return path.join(externalDBDir, '.secret');
    } else {
        // ä½¿ç”¨å†…ç½®æ•°æ®åº“ï¼Œå¯†é’¥å­˜å‚¨åœ¨å†…ç½®ç›®å½•
        return path.join(__dirname, '../../../data/.secret');
    }
}
```

## ğŸ”§ è¿ç§»æ­¥éª¤ï¼ˆæ›´æ–°ç‰ˆï¼‰

### åœºæ™¯ 1ï¼šå…¨æ–°éƒ¨ç½²ï¼ˆä½¿ç”¨å¤–éƒ¨æ•°æ®åº“ï¼‰

```bash
# 1. é…ç½® docker-compose.yml
volumes:
  - ./data:/data
  - /your/path:/external_db

# 2. å¯åŠ¨å®¹å™¨
docker-compose up -d

# 3. ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨ /your/path/.secret åˆ›å»ºå¯†é’¥
```

**æ— éœ€ä»»ä½•é¢å¤–æ“ä½œï¼** å¯†é’¥ä¼šè‡ªåŠ¨åˆ›å»ºåœ¨æ­£ç¡®çš„ä½ç½®ã€‚

### åœºæ™¯ 2ï¼šä»å†…ç½®æ•°æ®åº“è¿ç§»åˆ°å¤–éƒ¨æ•°æ®åº“

#### æ–¹æ³• Aï¼šåŒæ—¶è¿ç§»æ•°æ®åº“å’Œå¯†é’¥ï¼ˆæ¨èï¼‰

```bash
# 1. åœæ­¢å®¹å™¨
docker-compose down

# 2. åˆ›å»ºå¤–éƒ¨ç›®å½•
mkdir -p /your/path

# 3. å¤åˆ¶æ•°æ®åº“å’Œå¯†é’¥
cp ./data/ptdownload.db /your/path/
cp ./data/.secret /your/path/

# 4. é…ç½® docker-compose.yml
# volumes:
#   - /your/path:/external_db

# 5. å¯åŠ¨å®¹å™¨
docker-compose up -d
```

#### æ–¹æ³• Bï¼šåªè¿ç§»æ•°æ®åº“ï¼ˆé‡æ–°åŠ å¯†ï¼‰

```bash
# 1. åœæ­¢å®¹å™¨
docker-compose down

# 2. å¤åˆ¶æ•°æ®åº“
cp ./data/ptdownload.db /your/path/

# 3. é…ç½®å¹¶å¯åŠ¨
docker-compose up -d

# 4. æ–°å¯†é’¥ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œä½†éœ€è¦é‡æ–°é…ç½®ç«™ç‚¹
```

**æ³¨æ„**ï¼šæ–¹æ³• B éœ€è¦é‡æ–°è¾“å…¥æ‰€æœ‰ç«™ç‚¹çš„ Cookie å’Œ API Keyã€‚

### åœºæ™¯ 3ï¼šè·¨æœåŠ¡å™¨è¿ç§»

```bash
# æ—§æœåŠ¡å™¨
docker-compose down
tar -czf ptdownload-backup.tar.gz \
    ./data/ptdownload.db \
    ./data/.secret

# æ–°æœåŠ¡å™¨
tar -xzf ptdownload-backup.tar.gz
# å°†æ–‡ä»¶å¤åˆ¶åˆ°å¤–éƒ¨è·¯å¾„
cp ./data/ptdownload.db /your/path/
cp ./data/.secret /your/path/

# é…ç½®å¹¶å¯åŠ¨
docker-compose up -d
```

## ğŸ” éªŒè¯å¯†é’¥ä½ç½®

å¯åŠ¨å®¹å™¨åï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```bash
docker logs pt-app | grep Crypto
```

**ä½¿ç”¨å†…ç½®æ•°æ®åº“æ—¶ï¼š**
```
[Crypto] Loaded secret key from: /app/data/.secret
```

**ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“æ—¶ï¼š**
```
[Crypto] Loaded secret key from: /external_db/.secret
```

## âš ï¸ é‡è¦æç¤º

### 1. å¯†é’¥æ–‡ä»¶çš„é‡è¦æ€§

`.secret` æ–‡ä»¶åŒ…å«åŠ å¯†å¯†é’¥ï¼Œ**éå¸¸é‡è¦**ï¼š

- âœ… å¿…é¡»ä¸æ•°æ®åº“ä¸€èµ·å¤‡ä»½
- âœ… è¿ç§»æ—¶å¿…é¡»ä¸€èµ·å¤åˆ¶
- âœ… ä¸¢å¤±åæ— æ³•æ¢å¤åŠ å¯†æ•°æ®
- âš ï¸ ä¸è¦æäº¤åˆ° Git

### 2. å¦‚æœå¯†é’¥ä¸¢å¤±

å¦‚æœ `.secret` æ–‡ä»¶ä¸¢å¤±ï¼Œæ‚¨éœ€è¦ï¼š

1. é‡æ–°é…ç½®æ‰€æœ‰ç«™ç‚¹çš„ Cookie å’Œ API Key
2. ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ–°å¯†é’¥
3. é‡æ–°è¾“å…¥çš„æ•°æ®ä¼šç”¨æ–°å¯†é’¥åŠ å¯†

### 3. ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆé«˜çº§ï¼‰

æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šå¯†é’¥ï¼š

```yaml
# docker-compose.yml
environment:
  - APP_SECRET=your-secret-key-here
```

è¿™æ ·å¯†é’¥å°±ä¸ä¾èµ–æ–‡ä»¶ï¼Œä½†éœ€è¦ç¡®ä¿åœ¨æ‰€æœ‰ç¯å¢ƒä¸­ä½¿ç”¨ç›¸åŒçš„å€¼ã€‚

## ğŸ“‹ è¿ç§»æ£€æŸ¥æ¸…å•

è¿ç§»æ•°æ®åº“æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] å·²åœæ­¢æ—§ç¯å¢ƒçš„å®¹å™¨
- [ ] å·²å¤åˆ¶æ•°æ®åº“æ–‡ä»¶ `ptdownload.db`
- [ ] **å·²å¤åˆ¶å¯†é’¥æ–‡ä»¶ `.secret`** â­ é‡è¦
- [ ] ä¸¤ä¸ªæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
- [ ] å·²é…ç½®æ­£ç¡®çš„ volume æ˜ å°„
- [ ] å·²å¯åŠ¨æ–°å®¹å™¨
- [ ] å·²éªŒè¯å¯†é’¥åŠ è½½æˆåŠŸ
- [ ] å·²æµ‹è¯•ç«™ç‚¹åŠŸèƒ½æ­£å¸¸

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¤‡ä»½ç­–ç•¥

```bash
# å®Œæ•´å¤‡ä»½ï¼ˆåŒ…å«å¯†é’¥ï¼‰
tar -czf ptdownload-full-backup-$(date +%Y%m%d).tar.gz \
    /your/path/ptdownload.db \
    /your/path/.secret
```

### 2. NAS éƒ¨ç½²

åœ¨ NAS ä¸Šéƒ¨ç½²æ—¶ï¼Œç¡®ä¿å·æ˜ å°„åŒ…å«æ•´ä¸ªç›®å½•ï¼š

```
å®¿ä¸»æœº: /Container/PTdownload
å®¹å™¨å†…: /external_db

æ–‡ä»¶ç»“æ„:
/Container/PTdownload/
â”œâ”€â”€ ptdownload.db  â† æ•°æ®åº“
â””â”€â”€ .secret        â† å¯†é’¥ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```

### 3. å®šæœŸæ£€æŸ¥

å®šæœŸéªŒè¯å¯†é’¥æ–‡ä»¶å­˜åœ¨ï¼š

```bash
# å†…ç½®æ•°æ®åº“
ls -la ./data/.secret

# å¤–éƒ¨æ•°æ®åº“
ls -la /your/path/.secret
```

## ğŸ”„ æ•…éšœæ¢å¤

### é—®é¢˜ï¼šCookie/API Key æ˜¾ç¤ºä¸ºå¯†æ–‡

**åŸå› **ï¼šå¯†é’¥æ–‡ä»¶ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥å¯†é’¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   docker exec pt-app ls -la /external_db/.secret
   ```

2. å¦‚æœä¸å­˜åœ¨ï¼Œä»å¤‡ä»½æ¢å¤ï¼š
   ```bash
   cp backup/.secret /your/path/
   docker-compose restart
   ```

3. å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼Œéœ€è¦é‡æ–°é…ç½®ç«™ç‚¹

### é—®é¢˜ï¼šè¿ç§»åç«™ç‚¹æ— æ³•è®¿é—®

**å¯èƒ½åŸå› **ï¼šå¯†é’¥ä¸åŒ¹é…å¯¼è‡´ Cookie è§£å¯†å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ç¡®è®¤å¯†é’¥æ–‡ä»¶å·²æ­£ç¡®è¿ç§»
2. é‡å¯å®¹å™¨
3. å¦‚æœä»æœ‰é—®é¢˜ï¼Œé‡æ–°é…ç½®å—å½±å“çš„ç«™ç‚¹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“å¤–éƒ¨æŒ‚è½½ä½¿ç”¨æŒ‡å—](database-external-mount.md)
- [ä»å†…ç½®æ•°æ®åº“è¿ç§»åˆ°å¤–éƒ¨æ•°æ®åº“](migrate-to-external-db.md)
- [NAS Docker å›¾å½¢åŒ–ç•Œé¢éƒ¨ç½²æŒ‡å—](nas-docker-gui-guide.md)
