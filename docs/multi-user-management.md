# 多用户管理功能

## 功能概述

本次更新为 PTDownload 添加了完整的多用户管理功能，支持：

1. **修改当前账户用户名** - 所有用户都可以修改自己的用户名
2. **多用户管理** - 管理员可以添加、删除和管理其他用户
3. **角色权限控制** - 支持 `admin`（管理员）和 `user`（普通用户）两种角色

## 用户角色

| 角色 | 权限 |
|------|------|
| `admin` | 拥有所有权限，可以管理其他用户 |
| `user` | 普通用户，只能修改自己的账户信息 |

## 数据库变更

在 `users` 表中新增了 `role` 字段：

```sql
ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'
```

**迁移策略**：现有用户会自动被设置为 `admin` 角色。

## API 接口

### 通用接口（所有登录用户）

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/auth/me` | 获取当前用户信息 |
| POST | `/api/auth/change-password` | 修改密码 |
| POST | `/api/auth/change-username` | 修改用户名 |

### 管理员接口（仅 admin 角色）

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/auth/users` | 获取所有用户列表 |
| POST | `/api/auth/users` | 创建新用户 |
| DELETE | `/api/auth/users/:id` | 删除用户 |
| PUT | `/api/auth/users/:id/role` | 修改用户角色 |
| PUT | `/api/auth/users/:id/username` | 修改用户名（管理员修改其他用户） |
| POST | `/api/auth/users/:id/reset-password` | 重置用户密码 |

## 安全限制

1. **不能删除自己** - 用户无法删除自己的账户
2. **最后一个管理员保护** - 系统不允许删除或降级最后一个管理员
3. **用户名唯一性** - 用户名必须唯一
4. **密码长度要求** - 密码至少 6 个字符
5. **用户名长度要求** - 用户名至少 2 个字符

## 前端界面

在 **设置 → 安全** 页面中，提供以下功能：

### 当前账户卡片
- 显示当前登录的用户名和角色
- 支持直接点击"修改用户名"进行编辑
- 修改用户名后会自动要求重新登录

### 修改密码卡片
- 输入当前密码、新密码和确认密码
- 密码最少 6 个字符

### 用户管理卡片（仅管理员可见）
- 显示所有用户列表，包含用户名、角色、创建时间
- 每个用户行提供操作按钮：
  - **角色切换** - 在管理员和普通用户之间切换
  - **重置密码** - 弹出对话框设置新密码
  - **删除** - 删除用户（有确认提示）

### 添加用户对话框
- 输入用户名、密码、确认密码
- 选择角色（管理员/普通用户）

## 使用示例

### 1. 修改 admin 账户名

1. 登录系统
2. 进入 **设置 → 安全**
3. 在"当前账户"卡片中点击"修改用户名"
4. 输入新用户名并保存
5. 系统会自动登出，使用新用户名重新登录

### 2. 添加新用户

1. 使用管理员账户登录
2. 进入 **设置 → 安全**
3. 在"用户管理"卡片中点击"+ 添加用户"
4. 填写用户名、密码，选择角色
5. 点击"创建用户"

### 3. 重置用户密码

1. 使用管理员账户登录
2. 进入 **设置 → 安全**
3. 在用户列表中找到目标用户
4. 点击"重置密码"按钮
5. 输入新密码并确认

## 文件变更列表

| 文件 | 变更内容 |
|------|----------|
| `server/src/services/authService.js` | 添加用户管理方法 |
| `server/src/routes/auth.js` | 添加用户管理 API 路由 |
| `server/src/db/index.js` | 添加 role 字段和迁移 |
| `client/src/pages/SettingsPage.jsx` | 添加用户管理 UI |
