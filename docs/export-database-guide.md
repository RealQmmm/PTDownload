# 数据库文件导出功能使用指南

## 功能概述

现在您可以直接在系统设置的"备份与恢复"页面导出完整的 SQLite 数据库文件，无需使用命令行或脚本。

## 使用方法

### 导出数据库文件

1. 登录 PTDownload 系统
2. 进入 **设置** → **系统设置** → **备份与恢复**
3. 在"导出数据库文件 (SQLite)"部分，点击 **导出数据库文件 (DB)** 按钮
4. 浏览器会自动下载数据库文件，文件名格式为 `ptdownload_YYYY-MM-DD.db`

### 两种导出方式对比

| 特性 | JSON 备份 | 数据库文件 (DB) |
|------|----------|----------------|
| **文件格式** | JSON 文本 | SQLite 二进制 |
| **文件大小** | 较大（可读文本） | 较小（压缩二进制） |
| **适用场景** | 跨版本迁移、查看配置 | 完整备份、外部存储 |
| **兼容性** | 跨版本兼容 | 需要相同版本 |
| **导入方式** | 通过 UI 导入 | 直接替换文件 |
| **包含内容** | 配置和数据 | 所有原始数据 |

## 使用场景

### 场景 1：迁移到外部数据库

如果您想将数据迁移到外部存储（NAS、网络存储等）：

1. 在设置页面导出数据库文件
2. 将下载的 `.db` 文件复制到外部存储位置
3. 修改 `docker-compose.yml` 配置外部数据库
4. 重启容器

详见：[从内置数据库迁移到外部数据库指南](migrate-to-external-db.md)

### 场景 2：定期备份

建议定期导出数据库文件作为备份：

```bash
# 建议备份频率
- 每周备份一次
- 重大配置更改前备份
- 系统升级前备份
```

### 场景 3：跨服务器迁移

迁移到新服务器时：

1. 在旧服务器导出数据库文件
2. 在新服务器上部署 PTDownload
3. 停止新服务器的容器
4. 将数据库文件复制到新服务器的 `./data/ptdownload.db`
5. 启动容器

## 注意事项

### ⚠️ 重要提示

1. **文件大小**：数据库文件大小取决于您的使用情况，通常在 1-50MB 之间
2. **下载时间**：大文件可能需要几秒钟下载时间，请耐心等待
3. **浏览器兼容性**：现代浏览器均支持，建议使用 Chrome、Firefox、Edge
4. **权限要求**：需要登录系统才能导出

### 🔒 安全建议

1. **妥善保管**：数据库文件包含所有敏感信息（站点 Cookie、API Key 等）
2. **加密存储**：建议将备份文件存储在加密的位置
3. **定期清理**：删除过期的备份文件
4. **访问控制**：不要将备份文件分享给他人

## 恢复数据

### 方法 1：使用导出的数据库文件

如果您导出了数据库文件，可以直接替换：

```bash
# 1. 停止容器
docker-compose down

# 2. 备份当前数据库（可选）
cp ./data/ptdownload.db ./data/ptdownload.db.backup

# 3. 复制导出的数据库文件
cp /path/to/downloaded/ptdownload_YYYY-MM-DD.db ./data/ptdownload.db

# 4. 启动容器
docker-compose up -d
```

### 方法 2：使用 JSON 备份

如果您导出了 JSON 备份，可以通过 UI 导入：

1. 进入 **设置** → **系统设置** → **备份与恢复**
2. 在"导入数据"部分，点击 **选择备份文件并导入**
3. 选择之前导出的 JSON 文件
4. 确认导入，系统会自动刷新

## 常见问题

### Q: 导出的数据库文件可以在其他版本使用吗？

A: 数据库文件是二进制格式，建议在相同版本之间使用。如果需要跨版本迁移，推荐使用 JSON 备份。

### Q: 导出失败怎么办？

A: 检查以下几点：
1. 确保已登录系统
2. 检查浏览器控制台是否有错误
3. 尝试使用 JSON 备份作为替代方案
4. 查看服务器日志：`docker logs pt-app`

### Q: 数据库文件太大怎么办？

A: 可以通过以下方式减小数据库大小：
1. 清理任务历史：设置 → 系统设置 → 维护工具 → 清空任务历史
2. 清理热力图数据：设置 → 系统设置 → 维护工具 → 清空热力图
3. 减少日志保留天数：设置 → 常规设置 → 日志保留天数

### Q: 可以自动定期导出吗？

A: 目前需要手动导出。如果需要自动备份，可以使用以下方法：

```bash
# 创建定时任务（crontab）
0 2 * * 0 docker exec pt-app cp /data/ptdownload.db /backup/ptdownload_$(date +\%Y\%m\%d).db
```

## 技术细节

### 导出流程

1. 前端发送请求到 `/api/settings/export-database`
2. 后端读取数据库文件路径
3. 使用文件流传输数据库文件
4. 前端接收并触发浏览器下载

### 文件格式

- **格式**：SQLite 3 数据库文件
- **扩展名**：`.db`
- **MIME 类型**：`application/x-sqlite3`
- **编码**：二进制

### API 接口

```
GET /api/settings/export-database
```

**响应**：
- Content-Type: `application/x-sqlite3`
- Content-Disposition: `attachment; filename=ptdownload_YYYY-MM-DD.db`
- Content-Length: 文件大小（字节）

## 相关文档

- [数据库外部挂载使用指南](database-external-mount.md)
- [从内置数据库迁移到外部数据库](migrate-to-external-db.md)
- [数据库配置快速参考](database-quick-reference.md)
- [常见问题解答](database-faq.md)
