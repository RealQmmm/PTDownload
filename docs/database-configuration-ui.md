# 数据库配置功能使用指南

## 功能概述

在系统设置的"常规设置"页面，现在可以查看当前数据库的配置信息，包括：
- 当前使用的数据库模式（内置/外部）
- 数据库文件路径
- 数据库文件大小
- 如何切换数据库模式的说明

## 查看数据库配置

1. 登录 PTDownload 系统
2. 进入 **设置** → **常规设置**
3. 滚动到页面底部的 **数据库配置** 部分

### 显示的信息

- **当前数据库模式**：内置或外部
- **数据库路径**：当前数据库文件的完整路径
- **数据库大小**：数据库文件的大小（自动格式化为 B/KB/MB）
- **外部路径配置**：如果使用内置数据库，显示配置的外部路径

## 切换数据库模式

### 方法 1：修改环境变量（推荐）

#### 切换到外部数据库

1. 编辑 `docker-compose.yml` 文件：
```yaml
environment:
  - USE_EXTERNAL_DB=true  # 改为 true
  - EXTERNAL_DB_PATH=/external_db/ptdownload.db

volumes:
  - ./data:/data
  - /path/to/your/database:/external_db  # 取消注释并设置路径
```

2. 重启容器：
```bash
docker-compose restart
```

3. 刷新页面，查看数据库配置是否已更新

#### 切换回内置数据库

1. 编辑 `docker-compose.yml` 文件：
```yaml
environment:
  - USE_EXTERNAL_DB=false  # 改为 false
```

2. 重启容器：
```bash
docker-compose restart
```

### 方法 2：导出并迁移数据库文件

如果您想将现有数据迁移到外部存储：

1. 在 **设置** → **常规设置** → **数据库配置** 中，点击 **💾 导出数据库** 按钮
2. 或者进入 **设置** → **系统设置** → **备份与恢复**，点击 **导出数据库文件 (DB)**
3. 将下载的数据库文件复制到外部存储位置
4. 修改 `docker-compose.yml` 设置 `USE_EXTERNAL_DB=true`
5. 重启容器

## 快速操作

### 导出数据库

点击 **💾 导出数据库** 按钮，会自动跳转到"备份与恢复"页面，您可以在那里导出完整的数据库文件。

### 刷新信息

点击 **🔄 刷新信息** 按钮，重新获取最新的数据库配置信息（例如，在修改配置并重启容器后）。

## 使用场景

### 场景 1：查看当前配置

快速了解系统当前使用的是内置数据库还是外部数据库，以及数据库文件的大小。

### 场景 2：准备迁移

在迁移到外部数据库之前，先查看当前数据库的大小和路径，确认迁移计划。

### 场景 3：验证配置

修改 `docker-compose.yml` 并重启容器后，通过"刷新信息"按钮验证配置是否生效。

### 场景 4：监控数据库大小

定期查看数据库文件大小，决定是否需要清理历史数据。

## 注意事项

### ⚠️ 重要提示

1. **需要重启**：修改数据库配置后，必须重启容器才能生效
2. **数据安全**：切换数据库模式前，建议先导出备份
3. **路径正确**：确保外部路径在 `docker-compose.yml` 中正确配置
4. **权限问题**：确保外部路径有正确的读写权限

### 🔒 安全建议

1. **定期备份**：无论使用哪种模式，都应定期导出数据库备份
2. **权限控制**：外部数据库目录应设置适当的访问权限
3. **加密存储**：如果使用 NAS，建议启用加密功能

## 常见问题

### Q: 修改配置后为什么还是显示旧的模式？

A: 需要重启容器才能生效。运行：
```bash
docker-compose restart
```
然后点击"刷新信息"按钮。

### Q: 如何知道配置是否正确？

A: 查看数据库配置部分的"当前数据库模式"标签：
- 蓝色"内置"标签 = 使用内置数据库
- 绿色"外部"标签 = 使用外部数据库

### Q: 数据库文件大小一直增长怎么办？

A: 可以通过以下方式减小数据库大小：
1. 进入 **设置** → **系统设置** → **维护工具**
2. 清空任务历史或热力图数据
3. 减少日志保留天数

### Q: 可以在运行时切换数据库吗？

A: 不可以。数据库路径在应用启动时确定，运行时切换需要重启容器。

## 技术细节

### API 接口

```
GET /api/settings/database-info
```

**响应示例**：
```json
{
  "currentMode": "internal",
  "currentPath": "/data/ptdownload.db",
  "externalPath": "/external_db/ptdownload.db",
  "dbSize": 2048576,
  "dbSizeFormatted": "2.00 MB",
  "canSwitch": true,
  "requiresRestart": true
}
```

### 环境变量

- `USE_EXTERNAL_DB`: 是否使用外部数据库（true/false）
- `EXTERNAL_DB_PATH`: 外部数据库在容器内的路径
- `DB_PATH`: 内置数据库路径（仅当 USE_EXTERNAL_DB=false 时使用）

## 相关文档

- [数据库外部挂载使用指南](database-external-mount.md)
- [从内置数据库迁移到外部数据库](migrate-to-external-db.md)
- [数据库文件导出功能](export-database-guide.md)
- [数据库配置快速参考](database-quick-reference.md)
- [常见问题解答](database-faq.md)
