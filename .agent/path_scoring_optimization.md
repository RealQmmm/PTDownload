# 路径匹配评分系统优化

## 修改时间
2026-01-04 21:43

## 问题描述

### 案例 1：纪录片剧集
**种子信息：**
- 名称：`Slow Road to Hainan 2025 S01 Complete 2160p WEB-DL H264 AAC-UBWEB`
- PT站点类别：`纪录`
- 特征：包含 `S01`（明确的季数标识）

### 案例 2：用户创建了"纪录片"路径
**问题：** 如果用户创建了"纪录片"存储路径，包含 S01 的纪录片剧集应该保存到哪里？
- 选项 A：保存到"纪录片"路径（按类别分类）
- 选项 B：保存到"剧集"路径（按内容类型分类）

**答案：** 应该**优先保存到"剧集"路径**，因为：
1. `S01` 是非常明确的剧集特征
2. 剧集的组织方式（按季、按集）与单集纪录片不同
3. 用户通常希望所有剧集（无论类别）都保存在一起

### 旧逻辑的问题

之前的评分系统存在两个严重缺陷：

#### 缺陷 1：季数标识检测依赖关键词匹配

```javascript
// 旧逻辑
if (category === '剧集' && /s\d{1,2}|season\s*\d{1,2}/i.test(name)) {
    score += 5;  // 只有在关键词匹配后才检测季数标识
}
```

**问题：**
1. 季数标识（`S01`）的检测**依赖于关键词匹配**
2. 如果种子名称中没有剧集关键词（如 `season`, `episode` 等），即使有 `S01`，也不会加分
3. 对于纪录片剧集（类别是"纪录"但包含 `S01`），无法正确识别为剧集

#### 缺陷 2：类别匹配优先级过高

```javascript
// 旧逻辑
if (match_by_category && torrentItem.category) {
    const exactMatch = downloadPaths.find(p => 
        p.name.includes(category)
    );
    if (exactMatch) {
        return exactMatch;  // 直接返回，不检查季数标识
    }
}
```

**问题：**
1. 如果创建了"纪录片"路径，所有类别为"纪录"的资源都会保存到这里
2. 即使包含明确的 `S01` 标识，也不会检查是否有剧集路径
3. 导致纪录片剧集无法保存到剧集路径

**结果：**
- `Slow Road to Hainan 2025 S01 Complete...` 这种纪录片剧集
- 虽然有明确的 `S01` 标识
- 但会被保存到"纪录片"路径，而不是"剧集"路径
- 用户需要手动移动文件

---

## 优化方案

### 核心思想

**将特征检测从关键词匹配中独立出来**，让系统能够：
1. 直接识别种子名称中的强特征（如 `S01`, `E01` 等）
2. 不依赖于关键词匹配
3. 不受 PT 站点类别的限制

### 新的评分逻辑

```javascript
// 新逻辑
for (const [category, keywords] of Object.entries(pathKeywords)) {
    if (category.toLowerCase() === pathName || pathName.includes(category.toLowerCase())) {
        // 1. 关键词匹配（基础分数）
        for (const keyword of keywords) {
            if (name.includes(keyword)) {
                score += 10;
                break;
            }
        }

        // 2. 剧集特征检测（独立于关键词匹配）
        if (category === '剧集') {
            // 强特征：季数标识
            if (/s\d{1,2}(?![0-9])|season\s*\d{1,2}/i.test(name)) {
                score += 15;  // 提高分数，因为这是强特征
            }
            // 弱特征：集数标识
            if (/e\d{1,3}|ep\d{1,3}|episode/i.test(name)) {
                score += 8;
            }
        }

        // 3. 电影特征检测（独立于关键词匹配）
        if (category === '电影') {
            // 年份标识（更精确的正则）
            if (/\b(19|20)\d{2}\b/.test(name)) {
                score += 5;
            }
            // 电影特有格式标识
            if (/bluray|bdrip|remux|hdtv/i.test(name)) {
                score += 3;
            }
        }

        // 4. 动画特征检测
        if (category === '动画') {
            if (/\[.*\].*\d{2,3}[vp]?$/i.test(name) || /ova|ona/i.test(name)) {
                score += 8;
            }
        }
    }
}
```

---

## 评分规则详解

### 剧集路径评分

| 特征 | 正则表达式 | 分数 | 说明 |
|------|-----------|------|------|
| 关键词匹配 | `s0`, `s1`, `season`, `episode` 等 | +10 | 基础匹配 |
| 季数标识 | `/s\d{1,2}(?![0-9])|season\s*\d{1,2}/i` | +15 | **强特征**，如 S01, S02, Season 1 |
| 集数标识 | `/e\d{1,3}|ep\d{1,3}|episode/i` | +8 | 弱特征，如 E01, EP01 |
| 路径名匹配 | 种子名包含"剧集" | +15 | 直接名称匹配 |

**最高可能分数：** 10 (关键词) + 15 (季数) + 8 (集数) + 15 (名称) = **48分**

### 电影路径评分

| 特征 | 正则表达式 | 分数 | 说明 |
|------|-----------|------|------|
| 关键词匹配 | `movie`, `film`, `bluray` 等 | +10 | 基础匹配 |
| 年份标识 | `/\b(19|20)\d{2}\b/` | +5 | 如 1999, 2025 |
| 格式标识 | `/bluray|bdrip|remux|hdtv/i` | +3 | 电影特有格式 |
| 路径名匹配 | 种子名包含"电影" | +15 | 直接名称匹配 |

**最高可能分数：** 10 (关键词) + 5 (年份) + 3 (格式) + 15 (名称) = **33分**

### 动画路径评分

| 特征 | 正则表达式 | 分数 | 说明 |
|------|-----------|------|------|
| 关键词匹配 | `anime`, `animation`, `番剧` 等 | +10 | 基础匹配 |
| 动画特征 | `/\[.*\].*\d{2,3}[vp]?$/i` | +8 | 如 [字幕组] 标题 01v2 |
| OVA/ONA | `/ova|ona/i` | +8 | 动画特有类型 |
| 路径名匹配 | 种子名包含"动画" | +15 | 直接名称匹配 |

**最高可能分数：** 10 (关键词) + 8 (特征) + 15 (名称) = **33分**

---

## 案例分析

### 案例 1：纪录片剧集（问题案例）

**种子：** `Slow Road to Hainan 2025 S01 Complete 2160p WEB-DL H264 AAC-UBWEB`

**假设路径：**
- 电影 `/downloads/movies`
- 剧集 `/downloads/series`
- 纪录片 `/downloads/documentary`

#### 旧逻辑评分
```
电影路径：
  - 年份 2025: +3
  - WEB-DL: +3
  总分: 6

剧集路径：
  - 无关键词匹配: 0
  - S01 未被检测（因为没有关键词匹配）
  总分: 0

纪录片路径：
  - 无匹配
  总分: 0

结果：选择"电影"路径 ❌ 错误
```

#### 新逻辑评分
```
电影路径：
  - 年份 2025: +5
  - WEB-DL: +3
  总分: 8

剧集路径：
  - S01 季数标识: +15 ✨
  总分: 15

纪录片路径：
  - 无匹配
  总分: 0

结果：选择"剧集"路径 ✅ 正确
```

### 案例 2：普通电影

**种子：** `Avatar.The.Way.of.Water.2022.2160p.BluRay.REMUX.HDR.HEVC`

```
电影路径：
  - BluRay 关键词: +10
  - 年份 2022: +5
  - BluRay 格式: +3
  - REMUX 格式: +3
  总分: 21

剧集路径：
  - 无季数标识
  总分: 0

结果：选择"电影"路径 ✅ 正确
```

### 案例 3：剧集

**种子：** `The.Last.of.Us.S01E05.2023.2160p.WEB-DL.DDP5.1.Atmos.H.265`

```
电影路径：
  - 年份 2023: +5
  - WEB-DL 关键词: +10
  总分: 15

剧集路径：
  - S01 关键词: +10
  - S01 季数标识: +15
  - E05 集数标识: +8
  总分: 33

结果：选择"剧集"路径 ✅ 正确
```

---

## 改进点总结

### 1. 独立特征检测 ⭐
- 特征检测不再依赖关键词匹配
- 即使没有关键词，也能识别 `S01` 等强特征

### 2. 提高强特征权重
- 季数标识从 +5 提升到 +15
- 因为 `S01` 是非常明确的剧集标识

### 3. 更精确的正则表达式
- 年份：`/\b(19|20)\d{2}\b/` 避免匹配 2160p 中的 2160
- 季数：`/s\d{1,2}(?![0-9])/` 避免匹配 S01E05 中的 01

### 4. 新增动画特征检测
- 识别字幕组格式 `[字幕组] 标题 01`
- 识别 OVA/ONA 等动画特有类型

### 5. 分离电影格式检测
- 单独检测 BluRay, BDRip, REMUX 等电影特有格式
- 避免与剧集的 WEB-DL 混淆

---

## 测试建议

建议测试以下场景：

1. **纪录片剧集**
   - `BBC.Planet.Earth.II.S01E01.2016.2160p.BluRay`
   - 应选择：剧集路径

2. **纪录片电影**
   - `BBC.Planet.Earth.2006.2160p.BluRay.REMUX`
   - 应选择：电影路径

3. **动画剧集**
   - `[Anime] Demon Slayer S03E01 [1080p]`
   - 应选择：剧集路径（如果有）或动画路径

4. **综艺剧集**
   - `Running.Man.S2025E01.2025.1080p.WEB-DL`
   - 应选择：剧集路径（如果有）或综艺路径

5. **普通电影**
   - `Oppenheimer.2023.2160p.BluRay.REMUX.HDR`
   - 应选择：电影路径

---

## 未来优化方向

1. **学习用户选择**
   - 记录用户手动修改的路径选择
   - 优化评分权重

2. **自定义评分规则**
   - 允许用户自定义特征和分数
   - 支持正则表达式规则

3. **多语言支持**
   - 识别中文、日文等非英文命名
   - 支持更多国际化格式

4. **智能分类建议**
   - 当评分接近时，提示用户可能的多个选择
   - 显示评分详情，帮助用户理解匹配原因
