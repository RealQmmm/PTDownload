# ç´¯è®¡ä¸Šä¼ /ä¸‹è½½é‡åˆå§‹å€¼è®¾ç½®æœºåˆ¶

## æ¦‚è¿°
ç´¯è®¡ä¸Šä¼ å’Œä¸‹è½½é‡çš„åˆå§‹å€¼æ˜¯åœ¨**é¦–æ¬¡è¿è¡Œ**æ—¶è‡ªåŠ¨è®¾ç½®çš„ï¼Œé‡‡ç”¨**æ™ºèƒ½åˆå§‹åŒ–**ç­–ç•¥ã€‚

---

## åˆå§‹åŒ–æ—¶æœº

### æ—¶æœº1: æ•°æ®åº“åˆå§‹åŒ– ğŸ—„ï¸
**æ—¶é—´**: é¦–æ¬¡å¯åŠ¨æœåŠ¡æ—¶  
**æ–‡ä»¶**: `server/src/db/index.js:198`

```javascript
// åˆ›å»ºæ£€æŸ¥ç‚¹è®°å½•ï¼Œåˆå§‹å€¼å…¨éƒ¨ä¸º 0
db.prepare(`
    INSERT OR IGNORE INTO stats_checkpoint 
    (id, last_total_downloaded, last_total_uploaded, 
     historical_total_downloaded, historical_total_uploaded) 
    VALUES (1, 0, 0, 0, 0)
`).run();
```

**åˆå§‹çŠ¶æ€**:
```javascript
{
    last_total_downloaded: 0,        // ä¸Šæ¬¡ä¸‹è½½å™¨æ€»é‡
    last_total_uploaded: 0,          // ä¸Šæ¬¡ä¸‹è½½å™¨æ€»é‡
    historical_total_downloaded: 0,  // å†å²ç´¯è®¡ä¸‹è½½
    historical_total_uploaded: 0     // å†å²ç´¯è®¡ä¸Šä¼ 
}
```

---

### æ—¶æœº2: ç»Ÿè®¡æœåŠ¡åˆå§‹åŒ– ğŸ“Š
**æ—¶é—´**: æœåŠ¡å¯åŠ¨æ—¶  
**æ–‡ä»¶**: `server/src/services/statsService.js:28-50`

```javascript
async init() {
    const db = getDB();
    
    // 1. ä»æ•°æ®åº“åŠ è½½æ£€æŸ¥ç‚¹
    const checkpoint = db.prepare('SELECT * FROM stats_checkpoint WHERE id = 1').get();
    if (checkpoint) {
        this.memoryStats.lastTotalDownloaded = checkpoint.last_total_downloaded || 0;
        this.memoryStats.lastTotalUploaded = checkpoint.last_total_uploaded || 0;
        this.memoryStats.histDownloaded = checkpoint.historical_total_downloaded || 0;
        this.memoryStats.histUploaded = checkpoint.historical_total_uploaded || 0;
    }
    
    // 2. åŠ è½½ä»Šæ—¥ç»Ÿè®¡
    const todayStats = db.prepare('SELECT * FROM daily_stats WHERE date = ?').get(today);
    if (todayStats) {
        this.memoryStats.todayDownloaded = todayStats.downloaded_bytes || 0;
        this.memoryStats.todayUploaded = todayStats.uploaded_bytes || 0;
    }
    
    this.initialized = true;
    console.log('[Stats] Service initialized with memory cache');
}
```

**ä½œç”¨**: ä»æ•°æ®åº“æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€åˆ°å†…å­˜

---

### æ—¶æœº3: é¦–æ¬¡æ•°æ®é‡‡é›† ğŸ¯
**æ—¶é—´**: æœåŠ¡å¯åŠ¨åçš„**é¦–æ¬¡ collectStats()**  
**æ–‡ä»¶**: `server/src/services/statsService.js:115-119`

è¿™æ˜¯**æœ€å…³é”®**çš„åˆå§‹åŒ–é€»è¾‘ï¼

```javascript
// Calculate Deltas
if (this.memoryStats.lastTotalDownloaded > 0 || this.memoryStats.lastTotalUploaded > 0) {
    // æ­£å¸¸çš„å¢é‡è®¡ç®—
    let diffDL = currentTotalDownloaded - this.memoryStats.lastTotalDownloaded;
    let diffUL = currentTotalUploaded - this.memoryStats.lastTotalUploaded;
    // ...
} else {
    // â­ é¦–æ¬¡è¿è¡Œï¼šç›´æ¥ä½¿ç”¨ä¸‹è½½å™¨çš„å½“å‰æ€»é‡ä½œä¸ºåˆå§‹å€¼
    if (this.memoryStats.histDownloaded === 0) {
        this.memoryStats.histDownloaded = currentTotalDownloaded;
    }
    if (this.memoryStats.histUploaded === 0) {
        this.memoryStats.histUploaded = currentTotalUploaded;
    }
}

// æ›´æ–°åŸºå‡†å€¼
this.memoryStats.lastTotalDownloaded = currentTotalDownloaded;
this.memoryStats.lastTotalUploaded = currentTotalUploaded;
```

---

## å®Œæ•´åˆå§‹åŒ–æµç¨‹

### åœºæ™¯1: å…¨æ–°å®‰è£…ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æœåŠ¡å¯åŠ¨                                             â”‚
â”‚     node server/src/index.js                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ•°æ®åº“åˆå§‹åŒ–                                          â”‚
â”‚     initDB()                                            â”‚
â”‚                                                         â”‚
â”‚     åˆ›å»º stats_checkpoint è¡¨:                           â”‚
â”‚     INSERT INTO stats_checkpoint VALUES                 â”‚
â”‚       (1, 0, 0, 0, 0)                                   â”‚
â”‚                                                         â”‚
â”‚     åˆå§‹çŠ¶æ€:                                            â”‚
â”‚     â”œâ”€ last_total_downloaded: 0                         â”‚
â”‚     â”œâ”€ last_total_uploaded: 0                           â”‚
â”‚     â”œâ”€ historical_total_downloaded: 0                   â”‚
â”‚     â””â”€ historical_total_uploaded: 0                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç»Ÿè®¡æœåŠ¡åˆå§‹åŒ–                                        â”‚
â”‚     statsService.init()                                 â”‚
â”‚                                                         â”‚
â”‚     ä»æ•°æ®åº“åŠ è½½åˆ°å†…å­˜:                                   â”‚
â”‚     memoryStats = {                                     â”‚
â”‚       lastTotalDownloaded: 0,                           â”‚
â”‚       lastTotalUploaded: 0,                             â”‚
â”‚       histDownloaded: 0,                                â”‚
â”‚       histUploaded: 0,                                  â”‚
â”‚       todayDownloaded: 0,                               â”‚
â”‚       todayUploaded: 0                                  â”‚
â”‚     }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. é¦–æ¬¡æ•°æ®é‡‡é›† (ç«‹å³æ‰§è¡Œ)                               â”‚
â”‚     statsService.collectStats()                         â”‚
â”‚                                                         â”‚
â”‚     ä»ä¸‹è½½å™¨è·å–å½“å‰æ€»é‡:                                 â”‚
â”‚     currentTotalDownloaded = 156 GB  (qBittorrent)      â”‚
â”‚     currentTotalUploaded = 312 GB                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. åˆ¤æ–­æ˜¯å¦é¦–æ¬¡è¿è¡Œ                                      â”‚
â”‚                                                         â”‚
â”‚     if (lastTotalDownloaded > 0 || lastTotalUploaded > 0) {
â”‚         // ä¸æ˜¯é¦–æ¬¡ï¼Œæ­£å¸¸å¢é‡è®¡ç®—                         â”‚
â”‚     } else {                                            â”‚
â”‚         // â­ æ˜¯é¦–æ¬¡è¿è¡Œï¼                                â”‚
â”‚         if (histDownloaded === 0) {                     â”‚
â”‚             histDownloaded = currentTotalDownloaded;    â”‚
â”‚             // 156 GB                                   â”‚
â”‚         }                                               â”‚
â”‚         if (histUploaded === 0) {                       â”‚
â”‚             histUploaded = currentTotalUploaded;        â”‚
â”‚             // 312 GB                                   â”‚
â”‚         }                                               â”‚
â”‚     }                                                   â”‚
â”‚                                                         â”‚
â”‚     // æ›´æ–°åŸºå‡†å€¼                                        â”‚
â”‚     lastTotalDownloaded = 156 GB;                       â”‚
â”‚     lastTotalUploaded = 312 GB;                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. æŒä¹…åŒ–åˆ°æ•°æ®åº“ (5åˆ†é’Ÿå)                              â”‚
â”‚     statsService.persistStats()                         â”‚
â”‚                                                         â”‚
â”‚     UPDATE stats_checkpoint SET                         â”‚
â”‚       last_total_downloaded = 156 GB,                   â”‚
â”‚       last_total_uploaded = 312 GB,                     â”‚
â”‚       historical_total_downloaded = 156 GB,  â† åˆå§‹å€¼   â”‚
â”‚       historical_total_uploaded = 312 GB     â† åˆå§‹å€¼   â”‚
â”‚     WHERE id = 1                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯2: æœåŠ¡é‡å¯ï¼ˆå·²æœ‰æ•°æ®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æœåŠ¡å¯åŠ¨                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ç»Ÿè®¡æœåŠ¡åˆå§‹åŒ–                                        â”‚
â”‚     statsService.init()                                 â”‚
â”‚                                                         â”‚
â”‚     ä»æ•°æ®åº“æ¢å¤:                                         â”‚
â”‚     memoryStats = {                                     â”‚
â”‚       lastTotalDownloaded: 156 GB,    â† ä»æ•°æ®åº“æ¢å¤    â”‚
â”‚       lastTotalUploaded: 312 GB,      â† ä»æ•°æ®åº“æ¢å¤    â”‚
â”‚       histDownloaded: 500 GB,         â† ä»æ•°æ®åº“æ¢å¤    â”‚
â”‚       histUploaded: 1000 GB,          â† ä»æ•°æ®åº“æ¢å¤    â”‚
â”‚       todayDownloaded: 20 GB,         â† ä»æ•°æ®åº“æ¢å¤    â”‚
â”‚       todayUploaded: 40 GB            â† ä»æ•°æ®åº“æ¢å¤    â”‚
â”‚     }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ•°æ®é‡‡é›†                                             â”‚
â”‚     statsService.collectStats()                         â”‚
â”‚                                                         â”‚
â”‚     å½“å‰æ€»é‡: 160 GB                                     â”‚
â”‚     ä¸Šæ¬¡åŸºå‡†: 156 GB                                     â”‚
â”‚     å¢é‡: 4 GB                                          â”‚
â”‚                                                         â”‚
â”‚     histDownloaded += 4 GB  â†’ 504 GB                    â”‚
â”‚     todayDownloaded += 4 GB â†’ 24 GB                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®åˆ¤æ–­é€»è¾‘

### å¦‚ä½•åˆ¤æ–­æ˜¯å¦é¦–æ¬¡è¿è¡Œï¼Ÿ

**æ–‡ä»¶**: `server/src/services/statsService.js:94-119`

```javascript
// åˆ¤æ–­æ¡ä»¶
if (this.memoryStats.lastTotalDownloaded > 0 || this.memoryStats.lastTotalUploaded > 0) {
    // âŒ ä¸æ˜¯é¦–æ¬¡ï¼šlastTotal æœ‰å€¼ï¼Œè¯´æ˜ä¹‹å‰è¿è¡Œè¿‡
    // æ‰§è¡Œæ­£å¸¸çš„å¢é‡è®¡ç®—
} else {
    // âœ… æ˜¯é¦–æ¬¡ï¼šlastTotal ä¸º 0ï¼Œè¯´æ˜æ˜¯é¦–æ¬¡è¿è¡Œ
    // ä½¿ç”¨ä¸‹è½½å™¨å½“å‰æ€»é‡ä½œä¸ºåˆå§‹å€¼
    if (this.memoryStats.histDownloaded === 0) {
        this.memoryStats.histDownloaded = currentTotalDownloaded;
    }
    if (this.memoryStats.histUploaded === 0) {
        this.memoryStats.histUploaded = currentTotalUploaded;
    }
}
```

### åˆ¤æ–­ä¾æ®

| å­—æ®µ | é¦–æ¬¡è¿è¡Œ | å·²è¿è¡Œè¿‡ |
|------|---------|---------|
| `lastTotalDownloaded` | 0 | > 0 |
| `lastTotalUploaded` | 0 | > 0 |
| `histDownloaded` | 0 | > 0 |
| `histUploaded` | 0 | > 0 |

---

## åˆå§‹å€¼æ¥æº

### ä¸‹è½½å™¨çš„å½“å‰æ€»é‡

**qBittorrent**:
```javascript
GET /api/v2/transfer/info
è¿”å›: {
  dl_info_data: 167503724544,  // 156 GB â† ä½œä¸ºåˆå§‹å€¼
  up_info_data: 335007449088   // 312 GB â† ä½œä¸ºåˆå§‹å€¼
}
```

**Transmission**:
```javascript
POST /transmission/rpc
Method: session-stats
è¿”å›: {
  "cumulative-stats": {
    downloadedBytes: 167503724544,  // 156 GB â† ä½œä¸ºåˆå§‹å€¼
    uploadedBytes: 335007449088     // 312 GB â† ä½œä¸ºåˆå§‹å€¼
  }
}
```

---

## æ—¶é—´çº¿ç¤ºä¾‹

### å‡è®¾åœºæ™¯
- **é¦–æ¬¡å¯åŠ¨æ—¶é—´**: 2026-01-02 10:00:00
- **ä¸‹è½½å™¨å·²æœ‰æ•°æ®**: ä¸‹è½½ 156 GB, ä¸Šä¼  312 GB

```
10:00:00  æœåŠ¡å¯åŠ¨
          â”œâ”€ æ•°æ®åº“åˆå§‹åŒ–: æ‰€æœ‰å€¼ä¸º 0
          â””â”€ ç»Ÿè®¡æœåŠ¡åˆå§‹åŒ–: ä»æ•°æ®åº“åŠ è½½ï¼Œæ‰€æœ‰å€¼ä¸º 0

10:00:01  é¦–æ¬¡æ•°æ®é‡‡é›† (ç«‹å³æ‰§è¡Œ)
          â”œâ”€ ä» qBittorrent è·å–: DL=156GB, UP=312GB
          â”œâ”€ åˆ¤æ–­: lastTotal = 0 â†’ æ˜¯é¦–æ¬¡è¿è¡Œ
          â”œâ”€ è®¾ç½®åˆå§‹å€¼:
          â”‚   histDownloaded = 156 GB  â­
          â”‚   histUploaded = 312 GB    â­
          â””â”€ æ›´æ–°åŸºå‡†:
              lastTotalDownloaded = 156 GB
              lastTotalUploaded = 312 GB

10:00:11  ç¬¬äºŒæ¬¡æ•°æ®é‡‡é›† (10ç§’å)
          â”œâ”€ ä» qBittorrent è·å–: DL=156.5GB, UP=312.8GB
          â”œâ”€ åˆ¤æ–­: lastTotal = 156GB > 0 â†’ ä¸æ˜¯é¦–æ¬¡
          â”œâ”€ è®¡ç®—å¢é‡:
          â”‚   diffDL = 156.5 - 156 = 0.5 GB
          â”‚   diffUL = 312.8 - 312 = 0.8 GB
          â””â”€ ç´¯åŠ :
              histDownloaded = 156 + 0.5 = 156.5 GB
              histUploaded = 312 + 0.8 = 312.8 GB
              todayDownloaded = 0 + 0.5 = 0.5 GB
              todayUploaded = 0 + 0.8 = 0.8 GB

10:05:00  é¦–æ¬¡æŒä¹…åŒ– (5åˆ†é’Ÿå)
          â””â”€ å†™å…¥æ•°æ®åº“:
              UPDATE stats_checkpoint SET
                last_total_downloaded = 156.5 GB,
                last_total_uploaded = 312.8 GB,
                historical_total_downloaded = 156.5 GB,
                historical_total_uploaded = 312.8 GB
```

---

## ç‰¹æ®Šæƒ…å†µå¤„ç†

### æƒ…å†µ1: æ¸…ç©ºæ•°æ®åº“åé‡å¯

**åœºæ™¯**: ç”¨æˆ·åˆ é™¤äº†æ•°æ®åº“æ–‡ä»¶ï¼Œé‡æ–°å¯åŠ¨æœåŠ¡

**ç»“æœ**:
- æ•°æ®åº“é‡æ–°åˆå§‹åŒ–ï¼Œæ‰€æœ‰å€¼ä¸º 0
- é¦–æ¬¡é‡‡é›†æ—¶ï¼Œä½¿ç”¨ä¸‹è½½å™¨å½“å‰æ€»é‡ä½œä¸ºåˆå§‹å€¼
- âœ… **ä¸ä¼šä¸¢å¤±**ä¸‹è½½å™¨ä¸­å·²æœ‰çš„æµé‡ç»Ÿè®¡

---

### æƒ…å†µ2: æ›´æ¢ä¸‹è½½å™¨

**åœºæ™¯**: ä» qBittorrent (156GB) åˆ‡æ¢åˆ° Transmission (200GB)

**ç¬¬ä¸€æ¬¡é‡‡é›†**:
```javascript
currentTotal = 200 GB  (Transmission)
lastTotal = 156 GB     (qBittorrent çš„æœ€åå€¼)
diff = 200 - 156 = 44 GB

histDownloaded += 44 GB  // ä¼šå¤šè®¡ç®— 44GBï¼
```

**é—®é¢˜**: ä¼šé‡å¤è®¡ç®—ä¸åŒä¸‹è½½å™¨çš„æµé‡

**å»ºè®®**: æ›´æ¢ä¸‹è½½å™¨æ—¶ï¼Œæ‰‹åŠ¨é‡ç½®ç»Ÿè®¡æˆ–è°ƒæ•´åˆå§‹å€¼

---

### æƒ…å†µ3: ä¸‹è½½å™¨é‡å¯ï¼ˆç»Ÿè®¡å½’é›¶ï¼‰

**åœºæ™¯**: qBittorrent é‡å¯åï¼Œ`dl_info_data` ä» 156GB å˜ä¸º 0

**å¤„ç†**:
```javascript
currentTotal = 0 GB
lastTotal = 156 GB
diff = 0 - 156 = -156 GB

// è´Ÿå€¼å½’é›¶
if (diff < 0) diff = 0;

// ä¸ä¼šå‡å°‘å†å²ç»Ÿè®¡
histDownloaded ä¿æŒä¸å˜

// æ›´æ–°åŸºå‡†ä¸ºæ–°å€¼
lastTotal = 0 GB  // ä¸‹æ¬¡ä» 0 å¼€å§‹è®¡ç®—
```

**ç»“æœ**: âœ… å†å²ç»Ÿè®¡ä¸å—å½±å“ï¼Œä¸‹æ¬¡ä»æ–°åŸºå‡†å¼€å§‹è®¡ç®—

---

## ä»£ç ä½ç½®æ€»ç»“

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|------|
| æ•°æ®åº“åˆå§‹åŒ– | `server/src/db/index.js` | 198 | åˆ›å»ºæ£€æŸ¥ç‚¹ï¼Œåˆå§‹å€¼ä¸º 0 |
| æœåŠ¡åˆå§‹åŒ– | `server/src/services/statsService.js` | 28-50 | ä»æ•°æ®åº“æ¢å¤çŠ¶æ€ |
| é¦–æ¬¡è¿è¡Œåˆ¤æ–­ | `server/src/services/statsService.js` | 94-119 | åˆ¤æ–­å¹¶è®¾ç½®åˆå§‹å€¼ |
| æ•°æ®é‡‡é›† | `server/src/services/statsService.js` | 52-130 | æ¯10ç§’æ‰§è¡Œ |
| æ•°æ®æŒä¹…åŒ– | `server/src/services/statsService.js` | 137-187 | æ¯5åˆ†é’Ÿæ‰§è¡Œ |

---

## æ€»ç»“

### ç´¯è®¡æµé‡åˆå§‹å€¼è®¾ç½®æ—¶æœº

1. **æ•°æ®åº“åˆå§‹åŒ–**: åˆ›å»ºæ£€æŸ¥ç‚¹ï¼Œåˆå§‹å€¼ä¸º **0**
2. **æœåŠ¡åˆå§‹åŒ–**: ä»æ•°æ®åº“æ¢å¤çŠ¶æ€åˆ°å†…å­˜
3. **é¦–æ¬¡æ•°æ®é‡‡é›†**: ğŸ¯ **å…³é”®æ—¶åˆ»**
   - åˆ¤æ–­ `lastTotal` æ˜¯å¦ä¸º 0
   - å¦‚æœæ˜¯ 0 â†’ ä½¿ç”¨**ä¸‹è½½å™¨å½“å‰æ€»é‡**ä½œä¸ºåˆå§‹å€¼
   - å¦‚æœä¸æ˜¯ 0 â†’ æ­£å¸¸å¢é‡è®¡ç®—

### åˆå§‹å€¼æ¥æº

- âœ… **ä¸‹è½½å™¨çš„å½“å‰æ€»é‡**ï¼ˆqBittorrent æˆ– Transmissionï¼‰
- âœ… åŒ…å«ä¸‹è½½å™¨ä¸­å·²æœ‰çš„æ‰€æœ‰å†å²æ•°æ®
- âœ… ä¸ä¼šä» 0 å¼€å§‹ï¼Œé¿å…ä¸¢å¤±å·²æœ‰æµé‡

### ä¼˜åŠ¿

- ğŸš€ **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨è®¾ç½®
- ğŸ’¯ **å‡†ç¡®**: ä½¿ç”¨ä¸‹è½½å™¨çš„çœŸå®æ•°æ®
- ğŸ”„ **è¿ç»­**: æœåŠ¡é‡å¯åæ•°æ®ä¸ä¸¢å¤±
- ğŸ›¡ï¸ **å®¹é”™**: å¤„ç†ä¸‹è½½å™¨é‡å¯ç­‰å¼‚å¸¸æƒ…å†µ

### å…³é”®æ—¶é—´ç‚¹

```
æœåŠ¡å¯åŠ¨ â†’ ç«‹å³æ‰§è¡Œé¦–æ¬¡é‡‡é›† â†’ è®¾ç½®åˆå§‹å€¼ â†’ 5åˆ†é’ŸåæŒä¹…åŒ–
   â†“            â†“                  â†“              â†“
 0:00        0:01               0:01           5:00
```

**é¦–æ¬¡é‡‡é›†æ˜¯åœ¨æœåŠ¡å¯åŠ¨åçš„ç¬¬1ç§’**ï¼Œè¿™æ˜¯è®¾ç½®åˆå§‹å€¼çš„**å”¯ä¸€æ—¶æœº**ï¼
