# Task同步优化更新说明

## 更新时间
2026-01-02

## 更新内容

### 1. 延长后端轮询间隔 (5秒 → 10秒)

**目的**: 减少系统负载，降低对下载器的请求频率

**修改文件**:
- `server/src/index.js` (第79-82行)
  - 后端统计数据收集间隔从5秒改为10秒
  
- `client/src/pages/DashboardPage.jsx` (第217-221行)
  - **前端保持5秒刷新**，确保用户界面实时性

### 2. 自动删除孤立记录 (以下载器为准)

**目的**: 确保本地task_history表与下载器保持一致，自动清理已从下载器中删除的种子记录

**修改文件**:
- `server/src/services/statsService.js` (第328-371行)

**新增逻辑**:
在 `checkCompletionInternal` 方法中添加了第4步：删除孤立记录（DELETE ORPHANED RECORDS）

**工作流程**:
1. 获取所有 `task_history` 记录
2. 对每条记录检查是否存在于任何下载器中
3. 匹配方式：
   - 优先通过 `hash` 匹配（最可靠）
   - 备选通过 `名称 + 大小` 匹配（容错1%误差）
4. 如果记录在所有下载器中都不存在，则删除该记录
5. 记录删除数量并输出日志

**日志输出**:
- 启用系统日志时：每删除一条记录输出详细信息
- 总是输出：删除的总数量统计

## 影响范围

### 性能影响
- ✅ **正面**: 减少50%的轮询频率，降低CPU和网络负载
- ✅ **正面**: 自动清理无效记录，保持数据库整洁

### 功能影响
- ✅ **改进**: 数据同步更准确，以下载器为准
- ⚠️ **注意**: 如果手动从下载器删除种子，对应的历史记录也会被自动删除

### 用户体验
- 前端Dashboard保持5秒刷新，确保良好的实时性
- 后端数据收集降为10秒，减少系统负载
- 历史记录更准确，不会出现"幽灵记录"

## 测试建议

1. **基础测试**:
   - 启动服务，观察日志输出
   - 检查Dashboard是否正常显示

2. **同步测试**:
   - 在下载器中删除一个种子
   - 等待10-20秒（1-2个轮询周期）
   - 检查 `task_history` 表，确认记录已被删除

3. **性能测试**:
   - 观察CPU使用率是否有所降低
   - 检查下载器日志，确认请求频率降低

## 回滚方案

如需完全回滚到原来的5秒轮询且不删除记录：

1. 修改 `server/src/index.js` 第82行：
   ```javascript
   }, 5 * 1000);  // 改回5秒
   ```

2. 前端已保持5秒刷新，无需修改

3. 删除 `server/src/services/statsService.js` 第328-371行的孤立记录删除逻辑

## 相关代码位置

- 后端轮询: `/server/src/index.js:79-82`
- 前端轮询: `/client/src/pages/DashboardPage.jsx:217-221`
- 同步逻辑: `/server/src/services/statsService.js:194-371`
- 删除逻辑: `/server/src/services/statsService.js:328-371`
