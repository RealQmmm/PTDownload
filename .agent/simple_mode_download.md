# 简单模式下载功能实现

## 修改时间
2026-01-03

## 功能描述

当用户**未开启多路径管理功能**时，从搜索清单中点击下载按钮后，如果用户**只配置了一个下载器**，将弹出简化的下载确认框，确认后直接将默认下载地址和种子发送给下载器进行下载。

---

## 实现逻辑

### 核心设计理念

系统采用**两种互斥的下载模式**，由 `enableMultiPath` 开关控制：

1. **多路径管理开启** → 智能下载 或 高级选择模式
2. **多路径管理关闭** → 简单模式

---

### 模式 1: 多路径管理开启

**前提条件**:
- ✅ `enableMultiPath === true`

**行为**:

#### 1.1 智能下载模式（开启智能下载）
- 自动匹配路径
- 自动选择下载器
- 直接下载，无需确认

#### 1.2 高级选择模式（关闭智能下载）
- 显示完整的选择模态框
- 可选择路径（多个配置的路径 + 自定义）
- 可选择下载器

---

### 模式 2: 多路径管理关闭（简单模式）

**前提条件**:
- ✅ `enableMultiPath === false`
- ⚠️ 智能下载功能**不可用**（因为依赖多路径管理）

**行为**:

#### 2.1 单下载器场景
- 显示简化确认框
- 使用默认下载路径（或下载器默认）
- 确认后下载

#### 2.2 多下载器场景
- 显示选择下载器的模态框
- **不显示**路径选择（使用默认路径）
- 选择下载器后下载

---

### 下载流程决策树

```
点击下载按钮
    ↓
检查是否有下载器 ❌ → 提示添加下载器
    ↓ ✅
多路径管理开启？
    ↓ ✅ (enableMultiPath = true)
    ├─ 智能下载开启？
    │   ↓ ✅ (autoDownloadEnabled = true)
    │   ├─ 路径匹配成功？ ✅ → 自动下载
    │   └─ 路径匹配失败？ ❌ → 询问是否手动选择
    │   
    └─ 智能下载关闭？
        ↓ ❌ (autoDownloadEnabled = false)
        └─ 显示高级选择模态框（路径 + 下载器）
    
    ↓ ❌ (enableMultiPath = false)
    └─ 简单模式
        ├─ 只有1个下载器？ ✅ → 显示简化确认框
        └─ 多个下载器？ ❌ → 显示下载器选择模态框
```

---

### 用户体验流程

#### 场景 1: 已配置默认下载路径
```
用户点击下载按钮
    ↓
弹出确认框：
┌────────────────────────────────────┐
│ 确认下载到 [qBittorrent] 吗？      │
│ 保存路径: /downloads               │
│                                    │
│ 资源: "某电影.2160p.BluRay.mkv"    │
│ 大小: 25.6 GB                      │
│                                    │
│        [取消]    [确定]            │
└────────────────────────────────────┘
    ↓
用户点击确定
    ↓
直接下载到 /downloads 目录
```

#### 场景 2: 未配置默认下载路径
```
用户点击下载按钮
    ↓
弹出确认框：
┌────────────────────────────────────┐
│ 确认下载到 [qBittorrent] 吗？      │
│ 保存路径: 下载器默认路径            │
│                                    │
│ 资源: "某电影.2160p.BluRay.mkv"    │
│ 大小: 25.6 GB                      │
│                                    │
│        [取消]    [确定]            │
└────────────────────────────────────┘
    ↓
用户点击确定
    ↓
下载到下载器的默认路径
```

---

## 代码修改

### 文件: `client/src/pages/SearchPage.jsx`

#### 1. 新增状态变量
```javascript
const [defaultDownloadPath, setDefaultDownloadPath] = useState('');
const [enableMultiPath, setEnableMultiPath] = useState(false);
```

#### 2. 从设置中加载配置
```javascript
// Load default download path and multi-path switch
setDefaultDownloadPath(settingsData.default_download_path || '');
setEnableMultiPath(settingsData.enable_multi_path === 'true');
```

#### 3. 修改 `handleDownloadClick` 逻辑

在智能下载逻辑之后、显示选择模态框之前，添加简单模式判断：

```javascript
// 简单模式：多路径管理关闭 && 只有一个下载器
if (!enableMultiPath && clients.length === 1) {
    const client = clients[0];
    const clientName = client.name || client.type;
    const pathInfo = defaultDownloadPath 
        ? `\n保存路径: ${defaultDownloadPath}` 
        : '\n保存路径: 下载器默认路径';
    
    if (window.confirm(`确认下载到 [${clientName}] 吗？${pathInfo}\n\n资源: "${item.name}"\n大小: ${item.size}`)) {
        executeDownload(item, client.id, defaultDownloadPath || null);
    }
    return;
}
```

---

## 优先级逻辑

下载按钮点击后的处理优先级：

1. **检查下载器** → 如果没有配置下载器，提示用户添加
2. **智能下载模式** → 如果开启了智能下载，使用智能路径匹配
3. **简单模式** → 如果关闭多路径管理 && 只有一个下载器，显示简化确认框 ⭐ **新增**
4. **高级模式** → 如果有多个路径或多个下载器，显示完整的选择模态框
5. **兜底逻辑** → 只有一个下载器且无预定义路径，显示基础确认框

---

## 确认框信息展示

### 显示内容
- ✅ 下载器名称（优先显示自定义名称，否则显示类型）
- ✅ 保存路径（显示配置的默认路径或"下载器默认路径"）
- ✅ 资源名称
- ✅ 资源大小

### 信息格式
```
确认下载到 [下载器名称] 吗？
保存路径: [路径信息]

资源: "[资源名称]"
大小: [文件大小]
```

---

## 与其他模式的对比

| 模式 | 多路径管理 | 智能下载 | 用户操作 | 路径选择 |
|------|-----------|---------|---------|---------|
| **智能下载** | ✅ 开启 | ✅ 开启 | 点击下载 → 自动下载 | 自动匹配 |
| **高级选择** | ✅ 开启 | ❌ 关闭 | 点击下载 → 选择路径和下载器 → 下载 | 手动选择 |
| **简单模式** ⭐ | ❌ 关闭 | ❌ 不可用 | 点击下载 → 确认 → 下载 | 使用默认路径 |

---

## 用户配置建议

### 新手用户（推荐简单模式）
1. 配置一个下载器
2. 在「系统设置 - 下载」中设置默认下载路径
3. 保持多路径管理**关闭**
4. 享受简单的一键下载体验

### 高级用户（推荐智能下载）
1. **开启多路径管理** ⚠️ 必须
2. 配置多个分类路径
3. 开启智能下载
4. 配置多个下载器（可选）
5. 享受全自动的分类下载

---

## 优势

1. **简化新手体验** 🎯
   - 不需要理解路径管理的概念
   - 只需配置一次默认路径
   - 每次下载只需确认一次

2. **信息透明** 📋
   - 确认框清晰显示下载器和路径
   - 显示资源名称和大小
   - 用户可以在下载前确认所有信息

3. **灵活性** 🔄
   - 简单模式和高级模式可以无缝切换
   - 不影响现有的智能下载功能
   - 保持向后兼容

4. **安全性** 🔒
   - 需要用户确认才会下载
   - 防止误操作
   - 清晰显示下载目标

5. **逻辑清晰** 🎓
   - 两种模式互斥，不会混淆
   - 智能下载依赖多路径管理，逻辑合理
   - 降低用户理解成本

---

## 测试建议

### 测试场景 1: 简单模式（已配置默认路径）
1. **关闭**多路径管理
2. 配置默认下载路径为 `/downloads`
3. 只配置一个下载器
4. 搜索资源并点击下载
5. ✅ 验证显示简化确认框
6. ✅ 验证确认框显示正确的路径信息
7. ✅ 确认后验证下载到 `/downloads`

### 测试场景 2: 简单模式（未配置默认路径）
1. **关闭**多路径管理
2. 不配置默认下载路径（留空）
3. 只配置一个下载器
4. 搜索资源并点击下载
5. ✅ 验证确认框显示"下载器默认路径"
6. ✅ 确认后验证使用下载器默认路径

### 测试场景 3: 简单模式（多下载器）
1. **关闭**多路径管理
2. 配置多个下载器
3. 搜索资源并点击下载
4. ✅ 验证显示下载器选择模态框
5. ✅ 验证**不显示**路径选择（使用默认路径）

### 测试场景 4: 智能下载模式
1. **开启**多路径管理
2. **开启**智能下载
3. 配置多个路径
4. 搜索资源并点击下载
5. ✅ 验证直接自动下载（不显示确认框）
6. ✅ 验证下载到正确的匹配路径

### 测试场景 5: 高级选择模式
1. **开启**多路径管理
2. **关闭**智能下载
3. 配置多个路径
4. 搜索资源并点击下载
5. ✅ 验证显示完整的选择模态框
6. ✅ 验证可以选择路径和下载器

---

## 注意事项

1. **模式互斥**: 
   - 多路径管理开启 → 智能下载或高级选择
   - 多路径管理关闭 → 简单模式（智能下载不可用）

2. **路径传递**: 
   - 如果 `defaultDownloadPath` 为空，传递 `null` 给后端
   - 后端会使用下载器的默认路径

3. **确认框**: 
   - 使用原生 `window.confirm`，保持简单和快速
   - 显示所有关键信息，避免误操作

4. **兼容性**: 
   - 不影响现有的任何下载模式
   - 向后兼容所有配置

5. **逻辑清晰**:
   - 智能下载**必须**依赖多路径管理
   - 避免了矛盾的配置组合
