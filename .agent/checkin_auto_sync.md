# ç­¾åˆ°çŠ¶æ€è‡ªåŠ¨è”åŠ¨ä¼˜åŒ–

## æ›´æ–°æ—¶é—´
2026-01-02

## é—®é¢˜æè¿°
ä¹‹å‰æ£€æµ‹åˆ°ç«™ç‚¹å·²ç­¾åˆ°æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨ç‚¹äº®"å·²ç­¾åˆ°"å›¾æ ‡ï¼ˆå³ä¸æ›´æ–° `last_checkin_at` å­—æ®µï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨ä¼˜åŒ–å®ç°è‡ªåŠ¨è”åŠ¨ã€‚

## ä¼˜åŒ–å†…å®¹

### 1. å¢å¼ºç­¾åˆ°çŠ¶æ€æ£€æµ‹ ğŸ”

**æ–‡ä»¶**: `server/src/utils/siteParsers.js`

#### ä¼˜åŒ–å‰
```javascript
// åªæ£€æµ‹å°‘é‡å…³é”®è¯
const alreadyCheckedIn = text.includes('å·²ç»ç­¾åˆ°') ||
    text.includes('ä»Šæ—¥å·²ç­¾åˆ°') ||
    text.includes('ç­¾åˆ°æˆåŠŸ') ||
    text.includes('å·²ç­¾åˆ°') ||
    text.includes('Attendance successful') ||
    text.includes('You have already attended') ||
    text.includes('You have already earned');

// æœ‰é—®é¢˜çš„é€»è¾‘ï¼šæ‰¾ä¸åˆ°ç­¾åˆ°é“¾æ¥å°±è®¤ä¸ºå·²ç­¾åˆ°
const checkinLink = $('a[href*="attendance.php"]...');
stats.isCheckedIn = alreadyCheckedIn || (!checkinLink.length && ...);
```

**é—®é¢˜**:
- âŒ å…³é”®è¯è¦†ç›–ä¸å…¨ï¼Œå¯èƒ½æ¼æ£€
- âŒ é€»è¾‘ä¸å‡†ç¡®ï¼šæ‰¾ä¸åˆ°ç­¾åˆ°é“¾æ¥ â‰  å·²ç­¾åˆ°
- âŒ å¯èƒ½è¯¯åˆ¤æœªç­¾åˆ°çš„ç«™ç‚¹

#### ä¼˜åŒ–å
```javascript
// å¢å¼ºçš„å…³é”®è¯æ£€æµ‹
const alreadyCheckedIn = text.includes('å·²ç»ç­¾åˆ°') ||
    text.includes('ä»Šæ—¥å·²ç­¾åˆ°') ||
    text.includes('ç­¾åˆ°æˆåŠŸ') ||
    text.includes('å·²ç­¾åˆ°') ||
    text.includes('ä»Šå¤©å·²ç­¾') ||              // æ–°å¢
    text.includes('æ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°') ||        // æ–°å¢
    text.includes('æ‚¨å·²ç­¾åˆ°') ||              // æ–°å¢
    text.includes('è¿ç»­ç­¾åˆ°') ||              // æ–°å¢
    text.includes('Attendance successful') ||
    text.includes('You have already attended') ||
    text.includes('You have already earned') ||
    text.includes('Already checked in') ||    // æ–°å¢
    text.includes('already signed in') ||     // æ–°å¢
    html.includes('å·²ç­¾åˆ°') ||                // æ–°å¢ï¼šæ£€æŸ¥HTML
    html.includes('signed_in') ||             // æ–°å¢ï¼šCSSç±»å
    html.includes('checked_in');              // æ–°å¢ï¼šCSSç±»å

// åªæœ‰æ˜ç¡®æ£€æµ‹åˆ°ç­¾åˆ°å…³é”®è¯æ‰æ ‡è®°ä¸ºå·²ç­¾åˆ°
stats.isCheckedIn = alreadyCheckedIn;
```

**æ”¹è¿›**:
- âœ… æ–°å¢ 9 ä¸ªå…³é”®è¯æ£€æµ‹
- âœ… åŒæ—¶æ£€æµ‹æ–‡æœ¬å’ŒHTMLï¼ˆCSSç±»åï¼‰
- âœ… ç§»é™¤ä¸å‡†ç¡®çš„é€»è¾‘åˆ¤æ–­
- âœ… åªåœ¨æœ‰æ˜ç¡®è¯æ®æ—¶æ‰æ ‡è®°ä¸ºå·²ç­¾åˆ°

---

### 2. è‡ªåŠ¨æ›´æ–°ç­¾åˆ°æ—¶é—´ â°

**æ–‡ä»¶**: `server/src/services/siteService.js`

#### å·¥ä½œæœºåˆ¶
å½“æ£€æµ‹åˆ° `stats.isCheckedIn === true` æ—¶ï¼Œè‡ªåŠ¨æ›´æ–° `last_checkin_at` å­—æ®µï¼š

```javascript
if (stats.isCheckedIn) {
    sql += ', last_checkin_at = ?';
    params.push(now);
    if (enableLogs) console.log(`[Checkin] ${site.name} detected as already checked in today`);
}
```

#### è§¦å‘åœºæ™¯

| åœºæ™¯ | è§¦å‘æ–¹å¼ | é¢‘ç‡ |
|------|---------|------|
| **Cookie å‘¨æœŸæ£€æŸ¥** | `checkCookie()` | æ¯60åˆ†é’Ÿ |
| **æ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡** | `refreshUserStats()` | ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ |
| **è‡ªåŠ¨ç­¾åˆ°å** | `checkinSite()` | æ¯å¤©æŒ‡å®šæ—¶é—´ |

---

### 3. æ·»åŠ è°ƒè¯•æ—¥å¿— ğŸ“

**æ–‡ä»¶**: `server/src/services/siteService.js`

#### æ—¥å¿—è¾“å‡º
```javascript
// checkCookie æ–¹æ³•
if (stats.isCheckedIn) {
    if (enableLogs) console.log(`[Checkin] ${site.name} detected as already checked in today`);
}

// refreshUserStats æ–¹æ³•
if (stats.isCheckedIn) {
    if (enableLogs) console.log(`[Checkin] ${site.name} detected as already checked in (via refresh)`);
}
```

#### å¯ç”¨æ—¥å¿—
åœ¨è®¾ç½®ä¸­å¯ç”¨ `enable_system_logs = true`ï¼Œå³å¯çœ‹åˆ°ç­¾åˆ°æ£€æµ‹æ—¥å¿—ã€‚

---

## å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§¦å‘ç‚¹ (3ç§æ–¹å¼)                                         â”‚
â”‚  1. Cookie å‘¨æœŸæ£€æŸ¥ (æ¯60åˆ†é’Ÿ)                            â”‚
â”‚  2. æ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡                                          â”‚
â”‚  3. è‡ªåŠ¨ç­¾åˆ°å®Œæˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¿é—®ç«™ç‚¹é¦–é¡µ                                             â”‚
â”‚  GET site.url (å¸¦ Cookie)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æ HTML                                               â”‚
â”‚  siteParsers.parseUserStats(html)                       â”‚
â”‚                                                         â”‚
â”‚  æ£€æµ‹ç­¾åˆ°å…³é”®è¯:                                          â”‚
â”‚  âœ“ "å·²ç»ç­¾åˆ°"                                            â”‚
â”‚  âœ“ "ä»Šæ—¥å·²ç­¾åˆ°"                                          â”‚
â”‚  âœ“ "ç­¾åˆ°æˆåŠŸ"                                            â”‚
â”‚  âœ“ "æ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°"                                       â”‚
â”‚  âœ“ "è¿ç»­ç­¾åˆ°"                                            â”‚
â”‚  âœ“ "Already checked in"                                 â”‚
â”‚  âœ“ CSSç±»: "signed_in", "checked_in"                     â”‚
â”‚  ... (å…±16ä¸ªå…³é”®è¯)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ æœªæ£€æµ‹åˆ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                                             â”‚
             â”‚  stats.isCheckedIn = false                  â”‚
             â”‚  ä¸æ›´æ–° last_checkin_at                     â”‚
             â”‚                                             â”‚
             â””â”€ æ£€æµ‹åˆ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
                â”‚  stats.isCheckedIn = true                   â”‚
                â”‚                                             â”‚
                â”‚  æ›´æ–°æ•°æ®åº“:                                 â”‚
                â”‚  UPDATE sites SET                           â”‚
                â”‚    last_checkin_at = NOW(),  â† è‡ªåŠ¨ç‚¹äº®å›¾æ ‡  â”‚
                â”‚    username = ?,                            â”‚
                â”‚    upload = ?,                              â”‚
                â”‚    download = ?,                            â”‚
                â”‚    ...                                      â”‚
                â”‚  WHERE id = ?                               â”‚
                â”‚                                             â”‚
                â”‚  æ—¥å¿—è¾“å‡º:                                   â”‚
                â”‚  [Checkin] ç«™ç‚¹å detected as already       â”‚
                â”‚            checked in today                 â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‰ç«¯æ˜¾ç¤ºæ•ˆæœ

### ç­¾åˆ°å›¾æ ‡è”åŠ¨

**ä½ç½®**: è®¾ç½®é¡µé¢ â†’ ç«™ç‚¹åˆ—è¡¨

```javascript
// å‰ç«¯åˆ¤æ–­é€»è¾‘
const isCheckedInToday = site.last_checkin_at && 
    new Date(site.last_checkin_at).toDateString() === new Date().toDateString();

// æ˜¾ç¤ºæ•ˆæœ
{isCheckedInToday ? (
    <span className="text-green-500">âœ… å·²ç­¾åˆ°</span>
) : (
    <button onClick={handleCheckin}>ç­¾åˆ°</button>
)}
```

### è‡ªåŠ¨æ›´æ–°æ—¶æœº

1. **Cookie æ£€æŸ¥æ—¶** (æ¯60åˆ†é’Ÿ)
   - è‡ªåŠ¨æ£€æµ‹ç­¾åˆ°çŠ¶æ€
   - å¦‚æœå·²ç­¾åˆ° â†’ è‡ªåŠ¨æ›´æ–° `last_checkin_at`
   - å‰ç«¯å›¾æ ‡è‡ªåŠ¨ç‚¹äº® âœ…

2. **æ‰‹åŠ¨åˆ·æ–°æ—¶**
   - ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®
   - æ£€æµ‹åˆ°å·²ç­¾åˆ° â†’ æ›´æ–°æ—¶é—´
   - å›¾æ ‡ç«‹å³ç‚¹äº®

3. **è‡ªåŠ¨ç­¾åˆ°å**
   - ç³»ç»Ÿè‡ªåŠ¨ç­¾åˆ°æˆåŠŸ
   - ç›´æ¥æ›´æ–° `last_checkin_at`
   - å›¾æ ‡æ˜¾ç¤ºå·²ç­¾åˆ°

---

## æ”¯æŒçš„ç­¾åˆ°å…³é”®è¯

### ä¸­æ–‡å…³é”®è¯
- âœ… å·²ç»ç­¾åˆ°
- âœ… ä»Šæ—¥å·²ç­¾åˆ°
- âœ… ç­¾åˆ°æˆåŠŸ
- âœ… å·²ç­¾åˆ°
- âœ… ä»Šå¤©å·²ç­¾
- âœ… æ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°
- âœ… æ‚¨å·²ç­¾åˆ°
- âœ… è¿ç»­ç­¾åˆ°

### è‹±æ–‡å…³é”®è¯
- âœ… Attendance successful
- âœ… You have already attended
- âœ… You have already earned
- âœ… Already checked in
- âœ… already signed in

### HTML/CSS æ ‡è¯†
- âœ… `signed_in` (CSSç±»å)
- âœ… `checked_in` (CSSç±»å)
- âœ… HTMLä¸­åŒ…å« "å·²ç­¾åˆ°"

---

## æµ‹è¯•å»ºè®®

### 1. åŸºç¡€æµ‹è¯•
```bash
# 1. å¯ç”¨ç³»ç»Ÿæ—¥å¿—
è®¾ç½® â†’ enable_system_logs = true

# 2. æ‰‹åŠ¨ç­¾åˆ°ä¸€ä¸ªç«™ç‚¹

# 3. ç­‰å¾…60åˆ†é’Ÿæˆ–æ‰‹åŠ¨è§¦å‘Cookieæ£€æŸ¥

# 4. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
[Checkin] ç«™ç‚¹å detected as already checked in today

# 5. æ£€æŸ¥æ•°æ®åº“
SELECT name, last_checkin_at FROM sites WHERE id = ?;
```

### 2. å…³é”®è¯æµ‹è¯•
è®¿é—®å·²ç­¾åˆ°çš„ç«™ç‚¹ï¼Œæ£€æŸ¥é¡µé¢æ˜¯å¦åŒ…å«ä»¥ä¸‹å…³é”®è¯ä¹‹ä¸€ï¼š
- "å·²ç»ç­¾åˆ°"
- "ä»Šæ—¥å·²ç­¾åˆ°"
- "ç­¾åˆ°æˆåŠŸ"
- ...

å¦‚æœåŒ…å«ä½†æœªè¢«æ£€æµ‹åˆ°ï¼Œå¯èƒ½éœ€è¦æ·»åŠ æ–°çš„å…³é”®è¯ã€‚

### 3. å‰ç«¯æµ‹è¯•
1. æ‰“å¼€è®¾ç½®é¡µé¢
2. æŸ¥çœ‹ç«™ç‚¹åˆ—è¡¨çš„ç­¾åˆ°å›¾æ ‡
3. åº”è¯¥æ˜¾ç¤º âœ… å·²ç­¾åˆ°ï¼ˆå¦‚æœ `last_checkin_at` æ˜¯ä»Šå¤©ï¼‰

---

## ä¼˜åŠ¿

### 1. è‡ªåŠ¨åŒ– ğŸ¤–
- âœ… æ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… Cookie æ£€æŸ¥æ—¶è‡ªåŠ¨è”åŠ¨
- âœ… å®æ—¶æ›´æ–°ç­¾åˆ°çŠ¶æ€

### 2. å‡†ç¡®æ€§ ğŸ“Š
- âœ… 16ä¸ªå…³é”®è¯è¦†ç›–
- âœ… æ–‡æœ¬ + HTML åŒé‡æ£€æµ‹
- âœ… ç§»é™¤ä¸å‡†ç¡®çš„é€»è¾‘

### 3. å¯è¿½æº¯ ğŸ“
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… æ–¹ä¾¿è°ƒè¯•å’ŒéªŒè¯
- âœ… å¯æŸ¥çœ‹æ£€æµ‹å†å²

### 4. ç”¨æˆ·ä½“éªŒ âœ¨
- âœ… å›¾æ ‡è‡ªåŠ¨ç‚¹äº®
- âœ… çŠ¶æ€å®æ—¶åŒæ­¥
- âœ… æ— éœ€æ‰‹åŠ¨åˆ·æ–°

---

## æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºé—®é¢˜
- `last_checkin_at` ä½¿ç”¨ ISO 8601 æ ¼å¼
- å‰ç«¯åˆ¤æ–­"ä»Šå¤©"æ—¶éœ€è¦è€ƒè™‘æœ¬åœ°æ—¶åŒº

### 2. ç«™ç‚¹å·®å¼‚
- ä¸åŒ PT ç«™ç‚¹çš„ç­¾åˆ°æç¤ºå¯èƒ½ä¸åŒ
- å¦‚æœæŸä¸ªç«™ç‚¹æœªè¢«æ£€æµ‹åˆ°ï¼Œå¯ä»¥æ·»åŠ æ–°çš„å…³é”®è¯

### 3. æ—¥å¿—æŸ¥çœ‹
- éœ€è¦å¯ç”¨ `enable_system_logs` æ‰èƒ½çœ‹åˆ°è°ƒè¯•æ—¥å¿—
- ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ä»¥å‡å°‘æ—¥å¿—é‡

---

## ç›¸å…³ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° |
|------|------|------|
| ç­¾åˆ°æ£€æµ‹é€»è¾‘ | `server/src/utils/siteParsers.js` | 258-276 |
| Cookieæ£€æŸ¥æ›´æ–° | `server/src/services/siteService.js` | 165-168 |
| åˆ·æ–°ç»Ÿè®¡æ›´æ–° | `server/src/services/siteService.js` | 261-264 |
| æ—¥å¿—è¾“å‡º | `server/src/services/siteService.js` | 168, 264 |

---

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼š

1. **å¢å¼ºæ£€æµ‹èƒ½åŠ›**: ä» 7 ä¸ªå…³é”®è¯å¢åŠ åˆ° 16 ä¸ª
2. **æ”¹è¿›åˆ¤æ–­é€»è¾‘**: ç§»é™¤ä¸å‡†ç¡®çš„é€»è¾‘ï¼Œåªåœ¨æœ‰æ˜ç¡®è¯æ®æ—¶æ ‡è®°
3. **è‡ªåŠ¨è”åŠ¨**: æ£€æµ‹åˆ°å·²ç­¾åˆ°æ—¶è‡ªåŠ¨æ›´æ–° `last_checkin_at`
4. **æ·»åŠ æ—¥å¿—**: æ–¹ä¾¿è°ƒè¯•å’ŒéªŒè¯

ç°åœ¨ï¼Œå½“ Cookie å‘¨æœŸæ£€æŸ¥æˆ–æ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°ç«™ç‚¹å·²ç­¾åˆ°ï¼Œä¼š**è‡ªåŠ¨ç‚¹äº®ç­¾åˆ°å›¾æ ‡**ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œï¼âœ…
