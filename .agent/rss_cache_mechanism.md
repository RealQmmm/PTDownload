# RSS ç¼“å­˜æœºåˆ¶

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### åŸæœ‰æœºåˆ¶çš„é—®é¢˜

å½“æ‚¨æœ‰å¤šä¸ªè¿½å‰§è®¢é˜…éƒ½è®¢é˜…åŒä¸€ä¸ªç«™ç‚¹æ—¶ï¼š

```
ä»»åŠ¡ 1 (M-Team, å‰§é›† A) â†’ GET https://m-team.cc/rss.xml
ä»»åŠ¡ 2 (M-Team, å‰§é›† B) â†’ GET https://m-team.cc/rss.xml  âŒ é‡å¤è¯·æ±‚
ä»»åŠ¡ 3 (M-Team, å‰§é›† C) â†’ GET https://m-team.cc/rss.xml  âŒ é‡å¤è¯·æ±‚
ä»»åŠ¡ 4 (M-Team, å‰§é›† D) â†’ GET https://m-team.cc/rss.xml  âŒ é‡å¤è¯·æ±‚
ä»»åŠ¡ 5 (M-Team, å‰§é›† E) â†’ GET https://m-team.cc/rss.xml  âŒ é‡å¤è¯·æ±‚
```

**é—®é¢˜**:
- ğŸ”´ é‡å¤è¯·æ±‚åŒä¸€ä¸ª RSS æº
- ğŸ”´ æµªè´¹ç½‘ç»œå¸¦å®½
- ğŸ”´ å¢åŠ ç«™ç‚¹æœåŠ¡å™¨å‹åŠ›
- ğŸ”´ å¯èƒ½è§¦å‘é¢‘ç‡é™åˆ¶
- ğŸ”´ æ‰§è¡Œæ•ˆç‡ä½ä¸‹

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šRSS ç¼“å­˜

### å·¥ä½œåŸç†

```
ä»»åŠ¡ 1 (M-Team, å‰§é›† A) â†’ GET RSS â†’ ç¼“å­˜ 5 åˆ†é’Ÿ âœ…
ä»»åŠ¡ 2 (M-Team, å‰§é›† B) â†’ ä½¿ç”¨ç¼“å­˜ âœ… (ä¸è¯·æ±‚)
ä»»åŠ¡ 3 (M-Team, å‰§é›† C) â†’ ä½¿ç”¨ç¼“å­˜ âœ… (ä¸è¯·æ±‚)
ä»»åŠ¡ 4 (M-Team, å‰§é›† D) â†’ ä½¿ç”¨ç¼“å­˜ âœ… (ä¸è¯·æ±‚)
ä»»åŠ¡ 5 (M-Team, å‰§é›† E) â†’ ä½¿ç”¨ç¼“å­˜ âœ… (ä¸è¯·æ±‚)
```

**æ•ˆæœ**:
- âœ… å‡å°‘ 80% çš„ HTTP è¯·æ±‚
- âœ… é™ä½ç½‘ç»œå¼€é”€
- âœ… é¿å…è§¦å‘åçˆ¬æœºåˆ¶
- âœ… æå‡æ‰§è¡Œæ•ˆç‡

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ç¼“å­˜ç»“æ„

```javascript
{
  "https://site1.com/rss.xml": {
    data: "<?xml version='1.0'?>...",
    timestamp: 1704211200000
  },
  "https://site2.com/rss.xml": {
    data: "<?xml version='1.0'?>...",
    timestamp: 1704211260000
  }
}
```

### ç¼“å­˜ç­–ç•¥

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| **ç¼“å­˜é”®** | RSS URL | æ¯ä¸ª RSS æºç‹¬ç«‹ç¼“å­˜ |
| **TTL** | 5 åˆ†é’Ÿ | ç¼“å­˜æœ‰æ•ˆæœŸ |
| **æ¸…ç†** | è‡ªåŠ¨ | æ¯æ¬¡è¯·æ±‚æ—¶æ¸…ç†è¿‡æœŸç¼“å­˜ |
| **å­˜å‚¨** | å†…å­˜ | Map æ•°æ®ç»“æ„ |

### æ ¸å¿ƒæ–¹æ³•

#### 1. `getRSSFeed(rssUrl, headers)`

è·å– RSS æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰

```javascript
// æ£€æŸ¥ç¼“å­˜
if (cached && !expired) {
    return cached.data;  // ä½¿ç”¨ç¼“å­˜
}

// è¯·æ±‚æ–°æ•°æ®
const response = await axios.get(rssUrl, { headers });

// æ›´æ–°ç¼“å­˜
this.rssCache.set(rssUrl, {
    data: response.data,
    timestamp: Date.now()
});

return response.data;
```

#### 2. `cleanCache()`

æ¸…ç†è¿‡æœŸç¼“å­˜

```javascript
for (const [url, entry] of this.rssCache.entries()) {
    if (expired(entry)) {
        this.rssCache.delete(url);
    }
}
```

#### 3. `clearCache()`

æ‰‹åŠ¨æ¸…ç©ºæ‰€æœ‰ç¼“å­˜

```javascript
this.rssCache.clear();
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ï¼š5 ä¸ªä»»åŠ¡ï¼ŒåŒä¸€ç«™ç‚¹ï¼Œæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡

#### ä¼˜åŒ–å‰

```
æ¯å°æ—¶:
  - HTTP è¯·æ±‚: 5 æ¬¡
  - æ•°æ®ä¼ è¾“: ~500KB (å‡è®¾æ¯ä¸ª RSS 100KB)
  - æ‰§è¡Œæ—¶é—´: ~15 ç§’ (æ¯ä¸ªä»»åŠ¡ 3 ç§’)

æ¯å¤© (24 å°æ—¶):
  - HTTP è¯·æ±‚: 120 æ¬¡
  - æ•°æ®ä¼ è¾“: ~12 MB
```

#### ä¼˜åŒ–å

```
æ¯å°æ—¶:
  - HTTP è¯·æ±‚: 1 æ¬¡ âœ… (å‡å°‘ 80%)
  - æ•°æ®ä¼ è¾“: ~100KB âœ… (å‡å°‘ 80%)
  - æ‰§è¡Œæ—¶é—´: ~3.5 ç§’ âœ… (å‡å°‘ 77%)

æ¯å¤© (24 å°æ—¶):
  - HTTP è¯·æ±‚: 24 æ¬¡ âœ… (å‡å°‘ 80%)
  - æ•°æ®ä¼ è¾“: ~2.4 MB âœ… (å‡å°‘ 80%)
```

---

## ğŸ¯ ä½¿ç”¨è¯´æ˜

### è‡ªåŠ¨ç”Ÿæ•ˆ

ç¼“å­˜æœºåˆ¶**è‡ªåŠ¨å¯ç”¨**ï¼Œæ— éœ€ä»»ä½•é…ç½®ã€‚

### æ—¥å¿—æ ‡è¯†

```bash
# é¦–æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
[RSS Cache] Fetching fresh data for https://example.com/rss.xml

# åç»­è¯·æ±‚ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
[RSS Cache] Using cached data for https://example.com/rss.xml (age: 45s)

# ç¼“å­˜æ¸…ç†
[RSS Cache] Cleaned expired cache for https://old-site.com/rss.xml
```

### è§‚å¯Ÿç¼“å­˜æ•ˆæœ

```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs -f pt-app | grep "RSS Cache"

# ç¤ºä¾‹è¾“å‡º
[RSS Cache] Fetching fresh data for https://m-team.cc/rss.xml
[RSS Cache] Using cached data for https://m-team.cc/rss.xml (age: 12s)
[RSS Cache] Using cached data for https://m-team.cc/rss.xml (age: 25s)
[RSS Cache] Using cached data for https://m-team.cc/rss.xml (age: 38s)
```

---

## ğŸ” ç¼“å­˜è¡Œä¸º

### ä½•æ—¶ä½¿ç”¨ç¼“å­˜

- âœ… ç›¸åŒçš„ RSS URL
- âœ… ç¼“å­˜æœªè¿‡æœŸï¼ˆ< 5 åˆ†é’Ÿï¼‰
- âœ… ä»»ä½•ä»»åŠ¡éƒ½å¯ä»¥å…±äº«

### ä½•æ—¶é‡æ–°è¯·æ±‚

- âŒ é¦–æ¬¡è®¿é—®è¯¥ RSS URL
- âŒ ç¼“å­˜å·²è¿‡æœŸï¼ˆ> 5 åˆ†é’Ÿï¼‰
- âŒ æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜

### ç¼“å­˜éš”ç¦»

ä¸åŒçš„ RSS URL **ç‹¬ç«‹ç¼“å­˜**ï¼š

```
https://site1.com/rss.xml  â†’ ç¼“å­˜ A
https://site1.com/rss2.xml â†’ ç¼“å­˜ B (ä¸åŒ URL)
https://site2.com/rss.xml  â†’ ç¼“å­˜ C (ä¸åŒç«™ç‚¹)
```

---

## âš™ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹ç¼“å­˜æ—¶é—´

å¦‚æœéœ€è¦è°ƒæ•´ç¼“å­˜ TTLï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰ï¼š

```javascript
// åœ¨ rssService.js çš„ constructor ä¸­
this.cacheTTL = 10 * 60 * 1000; // æ”¹ä¸º 10 åˆ†é’Ÿ
```

### æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜

å¦‚æœéœ€è¦å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ RSS æ•°æ®ï¼š

```javascript
const rssService = require('./services/rssService');
rssService.clearCache();
```

---

## ğŸ›¡ï¸ å®‰å…¨æ€§

### Cookie éš”ç¦»

è™½ç„¶ç¼“å­˜å…±äº« RSS æ•°æ®ï¼Œä½† **Cookie ä»ç„¶ç‹¬ç«‹ä½¿ç”¨**ï¼š

```javascript
// ä»»åŠ¡ 1 ä½¿ç”¨ç«™ç‚¹ A çš„ Cookie
await getRSSFeed(url, { Cookie: siteA.cookies });

// ä»»åŠ¡ 2 ä½¿ç”¨ç«™ç‚¹ B çš„ Cookie (å¦‚æœæ˜¯åŒä¸€ä¸ª URL)
await getRSSFeed(url, { Cookie: siteB.cookies });
```

**æ³¨æ„**: å¦‚æœå¤šä¸ªä»»åŠ¡ä½¿ç”¨åŒä¸€ä¸ª RSS URL ä½†ä¸åŒçš„ Cookieï¼Œç¼“å­˜çš„æ•°æ®å¯èƒ½ä¸å®Œå…¨ä¸€è‡´ã€‚è¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼ˆé€šå¸¸åŒä¸€ç«™ç‚¹çš„ RSS URL ç›¸åŒï¼ŒCookie ä¹Ÿç›¸åŒï¼‰ã€‚

### å†…å­˜ç®¡ç†

- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
- å†…å­˜å ç”¨ï¼šæ¯ä¸ªç¼“å­˜æ¡ç›® ~100KB
- æœ€å¤§ç¼“å­˜æ•°ï¼šæ— é™åˆ¶ï¼ˆä½†ä¼šè‡ªåŠ¨è¿‡æœŸï¼‰

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### ç¼“å­˜å‘½ä¸­ç‡

```
ç¼“å­˜å‘½ä¸­ç‡ = (æ€»ä»»åŠ¡æ•° - HTTP è¯·æ±‚æ•°) / æ€»ä»»åŠ¡æ•° Ã— 100%
```

**ç¤ºä¾‹**:
- æ€»ä»»åŠ¡: 10 æ¬¡
- HTTP è¯·æ±‚: 2 æ¬¡
- ç¼“å­˜å‘½ä¸­ç‡: 80%

### æ€§èƒ½æå‡

```
æ€§èƒ½æå‡ = (ä¼˜åŒ–å‰æ—¶é—´ - ä¼˜åŒ–åæ—¶é—´) / ä¼˜åŒ–å‰æ—¶é—´ Ã— 100%
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç¼“å­˜æ²¡æœ‰ç”Ÿæ•ˆ

**æ£€æŸ¥**:
1. ç¡®è®¤å¤šä¸ªä»»åŠ¡ä½¿ç”¨ç›¸åŒçš„ RSS URL
2. æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œé—´éš”æ˜¯å¦ < 5 åˆ†é’Ÿ
3. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æ˜¾ç¤º "Using cached data"

### é—®é¢˜ï¼šæ•°æ®ä¸æ˜¯æœ€æ–°çš„

**åŸå› **: ç¼“å­˜è¿˜åœ¨æœ‰æ•ˆæœŸå†…

**è§£å†³**:
- ç­‰å¾…ç¼“å­˜è¿‡æœŸï¼ˆæœ€å¤š 5 åˆ†é’Ÿï¼‰
- æˆ–æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜

### é—®é¢˜ï¼šå†…å­˜å ç”¨å¢åŠ 

**åŸå› **: ç¼“å­˜æ¡ç›®è¿‡å¤š

**è§£å†³**:
- ç¼“å­˜ä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¡ç›®
- å¦‚æœæ‹…å¿ƒå†…å­˜ï¼Œå¯ä»¥ç¼©çŸ­ TTL

---

## âœ… æµ‹è¯•éªŒè¯

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
docker exec pt-app node /app/test-rss-cache.js
```

**æœŸæœ›è¾“å‡º**:
```
=== RSS ç¼“å­˜åŠŸèƒ½æµ‹è¯• ===

ä»»åŠ¡ 1 æ‰§è¡Œ...
[Mock] HTTP Request #1 to https://example.com/rss.xml
[RSS Cache] Fetching fresh data for https://example.com/rss.xml

ä»»åŠ¡ 2 æ‰§è¡Œ (ç«‹å³)...
[RSS Cache] Using cached data for https://example.com/rss.xml (age: 0s)

...

âœ… æµ‹è¯•é€šè¿‡ï¼ç¼“å­˜æ­£å¸¸å·¥ä½œã€‚
ğŸ“Š æ€§èƒ½æå‡: å‡å°‘äº† 80% çš„ HTTP è¯·æ±‚
```

---

## ğŸ‰ æ€»ç»“

### ä¼˜åŠ¿

- âœ… **è‡ªåŠ¨ç”Ÿæ•ˆ**: æ— éœ€é…ç½®
- âœ… **æ˜¾è‘—æå‡**: å‡å°‘ 80% è¯·æ±‚
- âœ… **æ™ºèƒ½ç®¡ç†**: è‡ªåŠ¨è¿‡æœŸæ¸…ç†
- âœ… **é€æ˜ä½¿ç”¨**: ä¸å½±å“ç°æœ‰é€»è¾‘

### é€‚ç”¨åœºæ™¯

- âœ… å¤šä¸ªè¿½å‰§è®¢é˜…åŒä¸€ç«™ç‚¹
- âœ… RSS ä»»åŠ¡æ‰§è¡Œé¢‘ç‡é«˜
- âœ… ç«™ç‚¹æœ‰é¢‘ç‡é™åˆ¶
- âœ… ç½‘ç»œå¸¦å®½æœ‰é™

### æ³¨æ„äº‹é¡¹

- âš ï¸ ç¼“å­˜æ•°æ®å¯èƒ½ä¸æ˜¯å®æ—¶æœ€æ–°ï¼ˆæœ€å¤šå»¶è¿Ÿ 5 åˆ†é’Ÿï¼‰
- âš ï¸ å†…å­˜ä¸­å­˜å‚¨ï¼Œé‡å¯åæ¸…ç©º
- âš ï¸ ä¸åŒ Cookie å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼ˆç½•è§ï¼‰

---

**åŠŸèƒ½çŠ¶æ€**: âœ… **å·²å®ç°ï¼Œå¯ä»¥ä½¿ç”¨**
