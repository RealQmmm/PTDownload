# 路径匹配规则说明

## 修改时间
2026-01-04 21:45

## 严格优先级规则

系统按照以下**严格的优先级顺序**进行路径匹配：

### 优先级 1：PT 站点类别精确匹配 ⭐ 最高优先级

如果 PT 站点提供了类别字段（如"纪录"、"电影"、"剧集"等），系统会：
1. 查找路径名称与类别匹配的路径
2. **如果找到，直接返回，不再继续评分**

**示例：**
- 种子类别：`纪录`
- 存储路径：`纪录片 /downloads/documentary`
- 结果：✅ 直接匹配，保存到"纪录片"路径
- **即使种子包含 S01，也会保存到"纪录片"路径**

### 优先级 2：关键词评分匹配

如果第一优先级未匹配成功，进入评分系统：

#### 评分规则

**剧集路径：**
- 关键词匹配（`s0`, `s1`, `season`, `episode` 等）：+10
- 季数标识（`S01`, `S02`, `Season 1` 等）：+15 ⭐
- 集数标识（`E01`, `EP01`, `Episode` 等）：+8
- 路径名称出现在种子名称中：+15

**电影路径：**
- 关键词匹配（`movie`, `film`, `bluray` 等）：+10
- 年份标识（1900-2099）：+5
- 电影格式标识（`BluRay`, `BDRip`, `REMUX` 等）：+3
- 路径名称出现在种子名称中：+15

**动画路径：**
- 关键词匹配（`anime`, `animation`, `番剧` 等）：+10
- 动画特征（字幕组格式、OVA/ONA）：+8
- 路径名称出现在种子名称中：+15

**其他路径：**
- 关键词匹配：+10
- 路径名称出现在种子名称中：+15

**评分相同时：** 优先选择剧集路径（因为季数标识是强特征）

### 优先级 3：默认路径

如果评分系统未匹配成功（所有路径得分为 0），查找：
1. 标记为 `is_default = true` 的路径
2. 名称为"其他"、"默认"、"default"、"other"的路径

### 优先级 4：下载器默认路径

如果以上都未匹配，使用下载器的默认路径（不指定保存路径）

---

## 实际案例分析

### 案例 1：纪录片剧集 + 有"纪录片"路径

**种子：** `Slow Road to Hainan 2025 S01 Complete 2160p WEB-DL H264 AAC-UBWEB`
- PT 站点类别：`纪录`
- 特征：包含 `S01`

**存储路径：**
- 📁 电影 `/downloads/movies`
- 📁 剧集 `/downloads/series`
- 📁 纪录片 `/downloads/documentary`

**匹配过程：**
```
1. 优先级 1：类别精确匹配
   - PT 站点类别：纪录
   - 查找路径名称包含"纪录"的路径
   - ✅ 找到"纪录片"路径
   - 直接返回

结果：保存到"纪录片"路径 ✅
```

**说明：** 即使包含 `S01`，也会保存到"纪录片"路径，因为类别匹配的优先级最高。

---

### 案例 2：纪录片剧集 + 无"纪录片"路径

**种子：** `Slow Road to Hainan 2025 S01 Complete 2160p WEB-DL H264 AAC-UBWEB`
- PT 站点类别：`纪录`
- 特征：包含 `S01`

**存储路径：**
- 📁 电影 `/downloads/movies`
- 📁 剧集 `/downloads/series`

**匹配过程：**
```
1. 优先级 1：类别精确匹配
   - PT 站点类别：纪录
   - 查找路径名称包含"纪录"的路径
   - ❌ 未找到

2. 优先级 2：关键词评分匹配
   电影路径：
     - WEB-DL 关键词: +10
     - 年份 2025: +5
     总分: 15

   剧集路径：
     - S01 季数标识: +15
     总分: 15

   评分相同，优先选择剧集路径
   
结果：保存到"剧集"路径 ✅
```

**说明：** 没有"纪录片"路径时，通过评分系统识别为剧集。

---

### 案例 3：普通电影

**种子：** `Avatar.The.Way.of.Water.2022.2160p.BluRay.REMUX.HDR.HEVC`
- PT 站点类别：`电影`

**存储路径：**
- 📁 电影 `/downloads/movies`
- 📁 剧集 `/downloads/series`

**匹配过程：**
```
1. 优先级 1：类别精确匹配
   - PT 站点类别：电影
   - 查找路径名称包含"电影"的路径
   - ✅ 找到"电影"路径
   - 直接返回

结果：保存到"电影"路径 ✅
```

---

### 案例 4：剧集

**种子：** `The.Last.of.Us.S01E05.2023.2160p.WEB-DL.DDP5.1.Atmos.H.265`
- PT 站点类别：`剧集`

**存储路径：**
- 📁 电影 `/downloads/movies`
- 📁 剧集 `/downloads/series`

**匹配过程：**
```
1. 优先级 1：类别精确匹配
   - PT 站点类别：剧集
   - 查找路径名称包含"剧集"的路径
   - ✅ 找到"剧集"路径
   - 直接返回

结果：保存到"剧集"路径 ✅
```

---

## 核心改进总结

### ✅ 已实现的优化

1. **独立特征检测**
   - 季数标识（`S01`）的检测不再依赖关键词匹配
   - 即使没有剧集关键词，也能识别季数标识

2. **提高强特征权重**
   - 季数标识：+15 分（原来 +5）
   - 集数标识：+8 分（新增）

3. **更精确的正则表达式**
   - 年份：`/\b(19|20)\d{2}\b/` 避免匹配 2160p
   - 季数：`/s\d{1,2}(?![0-9])/` 避免误匹配

4. **新增动画特征检测**
   - 识别字幕组格式和 OVA/ONA

5. **详细调试日志**
   - 打印所有路径的评分
   - 方便调试和验证

6. **评分相同时的优先级**
   - 优先选择剧集路径（因为季数标识是强特征）

### ⚠️ 保持的原有逻辑

1. **严格的优先级顺序**
   - 类别精确匹配 > 关键词评分 > 默认路径 > 下载器默认
   - 不会跳过优先级

2. **类别匹配的绝对优先**
   - 如果类别匹配成功，直接返回
   - 不会检查季数标识或进行评分

---

## 用户使用建议

### 场景 1：希望按类别分类（纪录片、电影、剧集等）

**配置：**
- 创建"纪录片"路径
- 创建"电影"路径
- 创建"剧集"路径

**效果：**
- 纪录片剧集（类别：纪录，包含 S01）→ 保存到"纪录片"路径
- 普通纪录片（类别：纪录）→ 保存到"纪录片"路径
- 电影（类别：电影）→ 保存到"电影"路径
- 剧集（类别：剧集）→ 保存到"剧集"路径

### 场景 2：希望按内容类型分类（剧集 vs 非剧集）

**配置：**
- 创建"剧集"路径
- 创建"电影"路径
- **不创建**"纪录片"路径

**效果：**
- 纪录片剧集（类别：纪录，包含 S01）→ 通过评分识别为剧集 → 保存到"剧集"路径
- 普通纪录片（类别：纪录）→ 通过评分识别为电影 → 保存到"电影"路径
- 电影（类别：电影）→ 保存到"电影"路径
- 剧集（类别：剧集）→ 保存到"剧集"路径

### 场景 3：混合分类

**配置：**
- 创建"剧集"路径
- 创建"电影"路径
- 创建"动画"路径（但不创建"纪录片"路径）

**效果：**
- 纪录片剧集 → 保存到"剧集"路径（通过评分）
- 普通纪录片 → 保存到"电影"路径（通过评分）
- 动画剧集 → 保存到"动画"路径（类别匹配优先）
- 动画电影 → 保存到"动画"路径（类别匹配优先）

---

## 总结

**核心原则：** 严格按照优先级规则进行匹配

1. **类别匹配优先** - 如果 PT 站点提供了类别，且有对应的路径，直接使用
2. **评分系统兜底** - 如果类别未匹配，通过关键词和特征评分选择
3. **用户可控** - 通过创建或不创建特定路径，控制分类策略

**你的理解完全正确！** 👍 如果创建了"纪录片"路径，纪录片剧集会优先保存到"纪录片"路径。如果希望保存到"剧集"路径，不要创建"纪录片"路径即可。
