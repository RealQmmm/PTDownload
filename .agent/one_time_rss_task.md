# ä¸€æ¬¡æ€§RSSä»»åŠ¡åŠŸèƒ½

## æ›´æ–°æ—¶é—´
2026-01-02

## åŠŸèƒ½æè¿°
ä¸ºRSSä»»åŠ¡æ·»åŠ "ä¸€æ¬¡æ€§ä»»åŠ¡"åŠŸèƒ½ï¼Œé€‚ç”¨äºç”µå½±ç­‰åªéœ€è¦ä¸‹è½½ä¸€æ¬¡çš„èµ„æºã€‚å½“ä»»åŠ¡åŒ¹é…å¹¶æˆåŠŸæ·»åŠ ç§å­åï¼Œè‡ªåŠ¨ç¦ç”¨ä»»åŠ¡ï¼Œé¿å…æŒç»­è¿è¡Œæµªè´¹èµ„æºã€‚

---

## ä½¿ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯ âœ…
- **ç”µå½±ä¸‹è½½**: åŒ¹é…åˆ°ç”µå½±åè‡ªåŠ¨ç¦ç”¨
- **å•é›†åŠ¨ç”»**: ä¸‹è½½ç‰¹å®šä¸€é›†ååœæ­¢
- **ç‰¹å®šèµ„æº**: åªéœ€è¦ä¸‹è½½ä¸€æ¬¡çš„ä»»ä½•èµ„æº

### ä¸é€‚ç”¨åœºæ™¯ âŒ
- **è¿½å‰§ä»»åŠ¡**: éœ€è¦æŒç»­ç›‘æ§æ–°å‰§é›†
- **æŒç»­è®¢é˜…**: éœ€è¦é•¿æœŸè¿è¡Œçš„RSSè®¢é˜…

---

## åŠŸèƒ½å®ç°

### 1. æ•°æ®åº“å­—æ®µ

**è¡¨**: `tasks`  
**æ–°å¢å­—æ®µ**: `auto_disable_on_match`

```sql
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type TEXT DEFAULT 'rss',
    cron TEXT NOT NULL,
    -- ... å…¶ä»–å­—æ®µ ...
    enabled INTEGER DEFAULT 1,
    auto_disable_on_match INTEGER DEFAULT 0,  -- â­ æ–°å¢å­—æ®µ
    -- ... å…¶ä»–å­—æ®µ ...
);
```

**å­—æ®µè¯´æ˜**:
- `0` (é»˜è®¤): æ™®é€šä»»åŠ¡ï¼ŒæŒç»­è¿è¡Œ
- `1`: ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ŒåŒ¹é…åè‡ªåŠ¨ç¦ç”¨

---

### 2. å·¥ä½œæµç¨‹

```
RSSä»»åŠ¡æ‰§è¡Œ
    â†“
è·å–å¹¶è§£æRSS feed
    â†“
è¿‡æ»¤åŒ¹é…èµ„æº
    â†“
æ‰¾åˆ°åŒ¹é…ï¼Ÿ
    â”œâ”€ å¦ â†’ ç»§ç»­è¿è¡Œï¼Œç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œ
    â””â”€ æ˜¯ â†’ æ·»åŠ åˆ°ä¸‹è½½å™¨
         â†“
    æ·»åŠ æˆåŠŸï¼Ÿ
         â”œâ”€ å¦ â†’ ç»§ç»­è¿è¡Œ
         â””â”€ æ˜¯ â†’ æ£€æŸ¥ auto_disable_on_match
              â†“
         auto_disable_on_match = 1ï¼Ÿ
              â”œâ”€ å¦ â†’ ç»§ç»­è¿è¡Œï¼ˆæ™®é€šä»»åŠ¡ï¼‰
              â””â”€ æ˜¯ â†’ è‡ªåŠ¨ç¦ç”¨ä»»åŠ¡ â­
                   â”œâ”€ æ›´æ–°æ•°æ®åº“: enabled = 0
                   â”œâ”€ å–æ¶ˆè°ƒåº¦ä»»åŠ¡
                   â””â”€ è®°å½•æ—¥å¿—
```

---

### 3. æ ¸å¿ƒä»£ç 

#### æ•°æ®åº“è¿ç§»
**æ–‡ä»¶**: `server/src/db/index.js:225`

```javascript
migrations.push('ALTER TABLE tasks ADD COLUMN auto_disable_on_match INTEGER DEFAULT 0');
```

#### ä»»åŠ¡åˆ›å»º
**æ–‡ä»¶**: `server/src/services/taskService.js:23-29`

```javascript
createTask(task) {
    const { ..., auto_disable_on_match = 0 } = task;
    db.prepare(
        'INSERT INTO tasks (..., auto_disable_on_match) VALUES (..., ?)'
    ).run(..., auto_disable_on_match);
}
```

#### è‡ªåŠ¨ç¦ç”¨é€»è¾‘
**æ–‡ä»¶**: `server/src/services/rssService.js:199-213`

```javascript
// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ç¦ç”¨
if (matchCount > 0 && task.auto_disable_on_match) {
    console.log(`Task "${task.name}" matched ${matchCount} item(s). Auto-disabling.`);
    
    // 1. ç¦ç”¨ä»»åŠ¡
    db.prepare('UPDATE tasks SET enabled = 0 WHERE id = ?').run(task.id);
    
    // 2. å–æ¶ˆè°ƒåº¦
    schedulerService.cancelTask(task.id);
    
    // 3. è®°å½•æ—¥å¿—
    loggerService.log(
        `ä»»åŠ¡å·²å®ŒæˆåŒ¹é…å¹¶è‡ªåŠ¨ç¦ç”¨ï¼ˆåŒ¹é… ${matchCount} ä¸ªèµ„æºï¼‰`, 
        'success', 
        task.id
    );
}
```

---

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: åˆ›å»ºä»»åŠ¡æ—¶è®¾ç½®

#### APIè¯·æ±‚
```javascript
POST /api/tasks
{
    "name": "[ç”µå½±] é˜¿å‡¡è¾¾3",
    "type": "rss",
    "cron": "*/30 * * * *",
    "site_id": 1,
    "rss_url": "https://example.com/rss",
    "filter_config": "{\"keywords\":\"é˜¿å‡¡è¾¾,Avatar,2160p\"}",
    "client_id": 1,
    "save_path": "/downloads/movies",
    "category": "Movies",
    "enabled": 1,
    "auto_disable_on_match": 1  // â­ è®¾ç½®ä¸ºä¸€æ¬¡æ€§ä»»åŠ¡
}
```

### æ–¹æ³•2: ä¿®æ”¹ç°æœ‰ä»»åŠ¡

#### APIè¯·æ±‚
```javascript
PUT /api/tasks/:id
{
    // ... å…¶ä»–å­—æ®µ ...
    "auto_disable_on_match": 1  // â­ ä¿®æ”¹ä¸ºä¸€æ¬¡æ€§ä»»åŠ¡
}
```

---

## å‰ç«¯é›†æˆå»ºè®®

### ä»»åŠ¡åˆ›å»º/ç¼–è¾‘è¡¨å•

```jsx
<div className="form-group">
    <label>
        <input
            type="checkbox"
            checked={formData.auto_disable_on_match === 1}
            onChange={(e) => setFormData({
                ...formData,
                auto_disable_on_match: e.target.checked ? 1 : 0
            })}
        />
        ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ˆåŒ¹é…åè‡ªåŠ¨ç¦ç”¨ï¼‰
    </label>
    <p className="help-text">
        é€‚ç”¨äºç”µå½±ç­‰åªéœ€ä¸‹è½½ä¸€æ¬¡çš„èµ„æºã€‚åŒ¹é…å¹¶æ·»åŠ ç§å­åï¼Œä»»åŠ¡ä¼šè‡ªåŠ¨ç¦ç”¨ã€‚
    </p>
</div>
```

### ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º

```jsx
{task.auto_disable_on_match === 1 && (
    <span className="badge badge-info">
        ğŸ¬ ä¸€æ¬¡æ€§ä»»åŠ¡
    </span>
)}
```

---

## æ—¥å¿—è¾“å‡º

### å¯ç”¨ç³»ç»Ÿæ—¥å¿—åçš„è¾“å‡º

```bash
# æ™®é€šä»»åŠ¡ï¼ˆæŒç»­è¿è¡Œï¼‰
[RSS] Task "è¿½å‰§-æƒåŠ›çš„æ¸¸æˆ" matched 1 item(s).
æˆåŠŸå‘ç° 50 ä¸ªèµ„æºï¼ŒåŒ¹é… 1 ä¸ª

# ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ˆè‡ªåŠ¨ç¦ç”¨ï¼‰
[RSS] Task "[ç”µå½±] é˜¿å‡¡è¾¾3" matched 1 item(s). Auto-disabling as configured.
ä»»åŠ¡å·²å®ŒæˆåŒ¹é…å¹¶è‡ªåŠ¨ç¦ç”¨ï¼ˆåŒ¹é… 1 ä¸ªèµ„æºï¼‰
```

---

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1: ç”µå½±ä¸‹è½½

```javascript
// åˆ›å»ºä¸€æ¬¡æ€§ä»»åŠ¡
{
    "name": "[ç”µå½±] æ²™ä¸˜2 4K",
    "filter_config": "{\"keywords\":\"æ²™ä¸˜,Dune,2160p\"}",
    "auto_disable_on_match": 1  // â­ ä¸€æ¬¡æ€§ä»»åŠ¡
}

// æ‰§è¡Œæµç¨‹
10:00  åˆ›å»ºä»»åŠ¡ï¼Œå¯ç”¨
10:30  ç¬¬ä¸€æ¬¡æ‰§è¡Œ â†’ æœªæ‰¾åˆ°åŒ¹é…
11:00  ç¬¬äºŒæ¬¡æ‰§è¡Œ â†’ æœªæ‰¾åˆ°åŒ¹é…
11:30  ç¬¬ä¸‰æ¬¡æ‰§è¡Œ â†’ æ‰¾åˆ°åŒ¹é…ï¼
       â†’ æ·»åŠ åˆ°ä¸‹è½½å™¨
       â†’ è‡ªåŠ¨ç¦ç”¨ä»»åŠ¡ âœ…
       â†’ å–æ¶ˆè°ƒåº¦
12:00  ä¸å†æ‰§è¡Œï¼ˆå·²ç¦ç”¨ï¼‰
```

### åœºæ™¯2: è¿½å‰§ä»»åŠ¡ï¼ˆå¯¹æ¯”ï¼‰

```javascript
// åˆ›å»ºæ™®é€šä»»åŠ¡
{
    "name": "[è¿½å‰§] æƒåŠ›çš„æ¸¸æˆ S08",
    "filter_config": "{\"keywords\":\"Game.of.Thrones.S08\"}",
    "auto_disable_on_match": 0  // â­ æ™®é€šä»»åŠ¡
}

// æ‰§è¡Œæµç¨‹
10:00  åˆ›å»ºä»»åŠ¡ï¼Œå¯ç”¨
10:30  ç¬¬ä¸€æ¬¡æ‰§è¡Œ â†’ æ‰¾åˆ° S08E01 â†’ æ·»åŠ 
11:00  ç¬¬äºŒæ¬¡æ‰§è¡Œ â†’ æ‰¾åˆ° S08E02 â†’ æ·»åŠ 
11:30  ç¬¬ä¸‰æ¬¡æ‰§è¡Œ â†’ æ‰¾åˆ° S08E03 â†’ æ·»åŠ 
...    æŒç»­è¿è¡Œï¼Œç›‘æ§æ–°å‰§é›† âœ…
```

---

## æ‰‹åŠ¨é‡æ–°å¯ç”¨

å¦‚æœéœ€è¦é‡æ–°è¿è¡Œå·²ç¦ç”¨çš„ä¸€æ¬¡æ€§ä»»åŠ¡ï¼š

### æ–¹æ³•1: é€šè¿‡API
```javascript
PATCH /api/tasks/:id/toggle
{
    "enabled": true
}
```

### æ–¹æ³•2: é€šè¿‡å‰ç«¯
1. æ‰“å¼€ä»»åŠ¡åˆ—è¡¨
2. æ‰¾åˆ°å·²ç¦ç”¨çš„ä»»åŠ¡
3. ç‚¹å‡»"å¯ç”¨"æŒ‰é’®

---

## æ³¨æ„äº‹é¡¹

### 1. åŒ¹é…è®¡æ•°
- åªè¦ `matchCount > 0`ï¼Œä»»åŠ¡å°±ä¼šè¢«ç¦ç”¨
- å³ä½¿åŒ¹é…åˆ°å¤šä¸ªèµ„æºï¼Œä¹Ÿåªä¼šç¦ç”¨ä¸€æ¬¡

### 2. æ·»åŠ å¤±è´¥
- å¦‚æœåŒ¹é…åˆ°èµ„æºä½†æ·»åŠ å¤±è´¥ï¼Œä»»åŠ¡**ä¸ä¼š**è¢«ç¦ç”¨
- ä¸‹æ¬¡æ‰§è¡Œæ—¶ä¼šé‡è¯•

### 3. é‡å¤æ£€æŸ¥
- ä¸€æ¬¡æ€§ä»»åŠ¡ä»ç„¶ä¼šè¿›è¡Œé‡å¤æ£€æŸ¥ï¼ˆhashã€historyç­‰ï¼‰
- å¦‚æœèµ„æºå·²å­˜åœ¨ï¼Œä¸ä¼šæ·»åŠ ï¼Œä¹Ÿä¸ä¼šç¦ç”¨ä»»åŠ¡
- åªæœ‰**æˆåŠŸæ·»åŠ æ–°èµ„æº**æ—¶æ‰ä¼šç¦ç”¨

### 4. è°ƒåº¦å–æ¶ˆ
- ä»»åŠ¡ç¦ç”¨åï¼Œè°ƒåº¦ä¼šè¢«ç«‹å³å–æ¶ˆ
- ä¸ä¼šå†å ç”¨ç³»ç»Ÿèµ„æº

---

## æ•°æ®åº“è¿ç§»

### è‡ªåŠ¨è¿ç§»
æœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ·»åŠ  `auto_disable_on_match` å­—æ®µï¼š

```javascript
// server/src/db/index.js
migrations.forEach(sql => {
    try {
        db.exec(sql);
    } catch (e) {
        // å¿½ç•¥é‡å¤å­—æ®µé”™è¯¯
    }
});
```

### ç°æœ‰ä»»åŠ¡
- æ‰€æœ‰ç°æœ‰ä»»åŠ¡çš„ `auto_disable_on_match` é»˜è®¤ä¸º `0`
- ä¸ä¼šå½±å“ç°æœ‰ä»»åŠ¡çš„è¡Œä¸º
- å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ä¸ºä¸€æ¬¡æ€§ä»»åŠ¡

---

## ä¼˜åŠ¿

### 1. èµ„æºèŠ‚çœ ğŸ’°
- ä¸€æ¬¡æ€§ä»»åŠ¡å®Œæˆåè‡ªåŠ¨åœæ­¢
- ä¸å†å ç”¨CPUå’Œç½‘ç»œèµ„æº
- å‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨

### 2. ä»»åŠ¡ç®¡ç† ğŸ“‹
- è‡ªåŠ¨æ¸…ç†å®Œæˆçš„ä»»åŠ¡
- ä»»åŠ¡åˆ—è¡¨æ›´æ¸…æ™°
- å‡å°‘æ‰‹åŠ¨ç®¡ç†å·¥ä½œ

### 3. çµæ´»æ€§ ğŸ”„
- å¯ä»¥éšæ—¶é‡æ–°å¯ç”¨
- æ”¯æŒæ™®é€šä»»åŠ¡å’Œä¸€æ¬¡æ€§ä»»åŠ¡æ··ç”¨
- é€‚åº”ä¸åŒä½¿ç”¨åœºæ™¯

---

## ç›¸å…³ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° |
|------|------|------|
| æ•°æ®åº“å­—æ®µ | `server/src/db/index.js` | 93 |
| æ•°æ®åº“è¿ç§» | `server/src/db/index.js` | 225 |
| ä»»åŠ¡åˆ›å»º | `server/src/services/taskService.js` | 23-29 |
| ä»»åŠ¡æ›´æ–° | `server/src/services/taskService.js` | 31-36 |
| è‡ªåŠ¨ç¦ç”¨é€»è¾‘ | `server/src/services/rssService.js` | 199-213 |

---

## æµ‹è¯•å»ºè®®

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºä¸€æ¬¡æ€§ä»»åŠ¡**
```bash
# åˆ›å»ºä¸€ä¸ªåŒ¹é…æ¡ä»¶å¾ˆå®½æ¾çš„ä»»åŠ¡
POST /api/tasks
{
    "name": "[æµ‹è¯•] ä¸€æ¬¡æ€§ä»»åŠ¡",
    "filter_config": "{\"keywords\":\"test\"}",
    "auto_disable_on_match": 1
}
```

2. **ç­‰å¾…åŒ¹é…**
```bash
# ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå¹¶åŒ¹é…åˆ°èµ„æº
# æŸ¥çœ‹æ—¥å¿—è¾“å‡º
```

3. **éªŒè¯ç¦ç”¨**
```bash
# æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
GET /api/tasks/:id
# åº”è¯¥è¿”å› enabled: 0

# æ£€æŸ¥è°ƒåº¦
# ä»»åŠ¡ä¸åº”è¯¥å†æ‰§è¡Œ
```

4. **é‡æ–°å¯ç”¨**
```bash
# æµ‹è¯•é‡æ–°å¯ç”¨åŠŸèƒ½
PATCH /api/tasks/:id/toggle
{
    "enabled": true
}
```

---

## æ€»ç»“

### åŠŸèƒ½ç‰¹ç‚¹
- âœ… è‡ªåŠ¨ç¦ç”¨ï¼šåŒ¹é…åè‡ªåŠ¨åœæ­¢è¿è¡Œ
- âœ… èµ„æºèŠ‚çœï¼šä¸å†å ç”¨ç³»ç»Ÿèµ„æº
- âœ… çµæ´»ç®¡ç†ï¼šå¯éšæ—¶é‡æ–°å¯ç”¨
- âœ… å‘åå…¼å®¹ï¼šä¸å½±å“ç°æœ‰ä»»åŠ¡

### é€‚ç”¨åœºæ™¯
- ğŸ¬ ç”µå½±ä¸‹è½½
- ğŸ“º å•é›†èµ„æº
- ğŸµ ç‰¹å®šä¸“è¾‘
- ğŸ“š ç‰¹å®šä¹¦ç±

### ä½¿ç”¨å»ºè®®
- ç”µå½±ç­‰ä¸€æ¬¡æ€§èµ„æºï¼šè®¾ç½® `auto_disable_on_match = 1`
- è¿½å‰§ç­‰æŒç»­è®¢é˜…ï¼šä¿æŒ `auto_disable_on_match = 0`

**ç°åœ¨ä½ å¯ä»¥åˆ›å»ºä¸€æ¬¡æ€§RSSä»»åŠ¡ï¼ŒåŒ¹é…åè‡ªåŠ¨ç¦ç”¨ï¼Œä¸å†æµªè´¹èµ„æºï¼** ğŸ‰
